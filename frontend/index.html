<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuze - Anonymous Dating</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        :root {
            --primary: #ff6b9d;
            --primary-dark: #8b225e;
            --secondary: #667eea;
            --accent: #764ba2;
            --background: #0f0f0f;
            --surface: #1a1a1a;
            --card: #2a2a2a;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --success: #28a745;
            --warning: #ffc107;
            --error: #dc3545;
        }

        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Анимированный фон */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }

        /* VIP каталоги - 3 анкеты в ряд */
        .vip-catalogs {
            margin: 10px 0;
            padding: 0 10px;
            transition: all 0.3s ease;
        }

        .vip-catalogs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .vip-catalog-card {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            border-radius: 10px;
            padding: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .vip-catalog-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .vip-catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .vip-catalog-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
        }

        .vip-catalog-price {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.7rem;
        }

        /* Изменено: теперь все анкеты в одном ряду */
        .vip-profiles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }

        .vip-profile-preview {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 3/4;
            background: var(--card);
        }

        .vip-profile-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: blur(8px);
            transition: filter 0.3s ease;
        }

        .vip-profile-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 5px;
            color: white;
        }

        .vip-profile-info {
            text-align: center;
        }

        .vip-profile-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.6rem;
        }

        .vip-profile-age {
            font-size: 0.5rem;
            opacity: 0.8;
        }

        .vip-profile-city {
            font-size: 0.45rem;
            opacity: 0.6;
            margin-top: 1px;
        }

        .unlock-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .unlock-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .vip-catalog-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.55rem;
            opacity: 0.8;
        }

        /* Баннер под статистикой */
        .stats-banner {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            padding: 10px 14px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: white;
            display: none;
        }

        .stats-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stats-banner-text {
            flex: 1;
            font-weight: 600;
            font-size: 11px;
        }

        .stats-banner-link {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 14px;
            text-decoration: none;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stats-banner-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .close-stats-banner {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 3px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-stats-banner:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Language and Filters Selector - кнопка фильтров слева */
        .language-filters-selector {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .language-btn {
            background: rgba(255, 107, 157, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.2);
        }

        .language-btn:hover {
            background: rgba(255, 107, 157, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(255, 107, 157, 0.3);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--primary);
            border-radius: 12px;
            margin-top: 8px;
            min-width: 140px;
            display: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .language-dropdown.active {
            display: block;
            animation: dropdownAppear 0.3s ease;
        }

        @keyframes dropdownAppear {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .language-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 107, 157, 0.1);
            font-size: 13px;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: rgba(255, 107, 157, 0.1);
        }

        /* Кнопка фильтров - слева от языка */
        .filters-toggle {
            position: relative;
            display: flex;
            background: var(--primary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .filters-toggle:hover {
            background: var(--secondary);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .filter-bar {
            width: 18px;
            height: 2px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        /* Экран загрузки */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--background) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            animation: fadeInUp 1s ease;
        }

        .loading-logo {
            font-size: 42px;
            font-weight: 400;
            background: linear-gradient(45deg, #fff, #ff8fab);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 6px;
            text-transform: capitalize;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(25px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        /* Хедер - опущен на 15% */
        .main-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px 15px;
            position: relative;
            margin-top: 60px;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 5px;
            text-transform: capitalize;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 12px;
            font-weight: 400;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.7rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Активные фильтры - inline below header */
        .active-filters {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            flex: 1;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
        }

        .active-filters:empty {
            display: none;
        }

        .filter-tag {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .filter-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.4);
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .filter-tag .remove:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Боковые фильтры */
        .filters-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .filters-sidebar {
            position: fixed;
            top: 0;
            left: -400px;
            width: 380px;
            height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--primary);
            z-index: 1002;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 25px;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.5);
        }

        .filters-sidebar.active {
            left: 0;
        }

        .filters-header {
            padding: 0 0 25px 0;
            border-bottom: 1px solid rgba(255, 107, 157, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filters-title {
            color: var(--primary);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .close-btn {
            background: rgba(255, 107, 157, 0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 107, 157, 0.2);
            transform: rotate(90deg);
        }

        .filter-group {
            margin-bottom: 25px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .modern-select {
            width: 100%;
            padding: 12px 18px;
            background: rgba(255, 107, 157, 0.05);
            border: 2px solid var(--primary);
            border-radius: 12px;
            color: var(--text);
            font-size: 15px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b9d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 18px center;
            background-size: 14px;
            transition: all 0.3s ease;
        }

        .modern-select:hover {
            background-color: rgba(255, 107, 157, 0.1);
            border-color: var(--secondary);
        }

        .modern-select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .range-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-inputs input {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: rgba(255, 107, 157, 0.05);
            border: 1px solid var(--primary);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .range-inputs input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .range-inputs span {
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 18px;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 35px;
        }

        .filter-actions .btn {
            flex: 1;
        }

        /* Сетка карточек */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        /* Карточки */
        .card {
            background: var(--card);
            border-radius: 20px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 157, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 35px rgba(255, 107, 157, 0.3);
            border-color: rgba(255, 107, 157, 0.3);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            z-index: 2;
            box-shadow: 0 3px 12px rgba(255, 107, 157, 0.4);
        }

        .card-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
            transition: transform 0.4s ease;
        }

        .card:hover .card-image {
            transform: scale(1.05);
        }

        .card-content {
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 250px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-age {
            color: var(--primary);
            font-weight: 600;
            font-size: 1rem;
        }

        .card-info {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: rgba(255, 107, 157, 0.1);
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(255, 107, 157, 0.2);
            transition: all 0.3s ease;
        }

        .stat-badge:hover {
            background: rgba(255, 107, 157, 0.2);
            transform: translateY(-2px);
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 3px 12px rgba(255, 107, 157, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 107, 157, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 107, 157, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
        }

        .btn-pay {
            background: linear-gradient(135deg, var(--success), #1e7e34);
            color: white;
            box-shadow: 0 3px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-pay:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .btn-promo {
            background: linear-gradient(135deg, var(--warning), #e0a800);
            color: #000;
            box-shadow: 0 3px 12px rgba(255, 193, 7, 0.4);
        }

        .btn-promo:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.6);
        }

        /* Loading states */
        .loading {
            text-align: center;
            padding: 50px 15px;
            color: var(--text-secondary);
            font-size: 16px;
            grid-column: 1 / -1;
        }

        .no-profiles {
            text-align: center;
            padding: 70px 15px;
            color: var(--text-secondary);
            font-size: 16px;
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            border-radius: 18px;
            margin: 15px 0;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .no-profiles::before {
            content: "";
            display: block;
            font-size: 3.5rem;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--surface);
            margin: 15px auto;
            width: 95%;
            max-width: 480px;
            border-radius: 20px;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 107, 157, 0.2);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255, 107, 157, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(102, 126, 234, 0.1));
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-body {
            padding: 25px;
        }

        /* Слайдер фото с свайпом */
        .slider {
            position: relative;
            margin-bottom: 15px;
        }

        .slider-main {
            position: relative;
            width: 100%;
            height: 350px;
            border-radius: 18px;
            overflow: hidden;
            background: var(--card);
        }

        .slider-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .slider-image.active {
            display: block;
        }

        .slider-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            transform: translateY(-50%);
            z-index: 2;
        }

        .slider-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .slider-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .slider-thumbs {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .slider-thumb {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .slider-thumb.active {
            border-color: var(--primary);
        }

        .slider-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Комментарии */
        .comments-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 107, 157, 0.1);
        }

        .comments-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .comment-form {
            background: rgba(255, 107, 157, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 107, 157, 0.1);
            display: none;
        }

        .comment-form.active {
            display: block;
        }

        .comment-permission-required {
            background: rgba(255, 107, 157, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 107, 157, 0.2);
            text-align: center;
        }

        .comment-permission-text {
            color: var(--text);
            margin-bottom: 12px;
            font-size: 13px;
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 107, 157, 0.2);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            margin-bottom: 8px;
            resize: vertical;
            min-height: 70px;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .rating-select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 107, 157, 0.2);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .comments-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .comment {
            background: rgba(255, 107, 157, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 107, 157, 0.1);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .comment-author {
            font-weight: 600;
            color: var(--primary);
        }

        .comment-date {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .comment-text {
            color: var(--text);
            line-height: 1.5;
            font-size: 13px;
        }

        .no-comments {
            text-align: center;
            color: var(--text-secondary);
            padding: 25px;
            font-style: italic;
        }

        /* Промокод модалка */
        .promo-modal .modal-content {
            max-width: 380px;
        }

        .promo-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .promo-input {
            flex: 1;
            padding: 12px 18px;
            background: rgba(255, 107, 157, 0.05);
            border: 2px solid var(--primary);
            border-radius: 12px;
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .promo-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .promo-result {
            padding: 12px;
            border-radius: 10px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .promo-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .promo-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        /* Чат */
        .chat-modal {
            display: none;
            position: fixed;
            bottom: 65px;
            left: 5px;
            right: 5px;
            width: auto;
            height: 80%;
            background: var(--surface);
            border-radius: 20px;
            z-index: 2001;
            border: 1px solid rgba(255, 107, 157, 0.2);
            box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-header {
            padding: 12px 18px;
            border-bottom: 1px solid rgba(255, 107, 157, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(102, 126, 234, 0.1));
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .chat-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .chat-warning {
            padding: 12px 20px;
            background: rgba(255, 193, 7, 0.1);
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            font-size: 12px;
            line-height: 1.5;
            text-align: center;
        }

        .chat-body {
            padding: 20px;
            height: calc(100% - 200px);
            overflow-y: auto;
            background: var(--background);
        }

        .chat-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 107, 157, 0.1);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--surface);
        }

        .chat-input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-input {
            padding: 12px 18px;
            border: 1px solid rgba(255, 107, 157, 0.2);
            border-radius: 20px;
            outline: none;
            background: rgba(255, 107, 157, 0.05);
            color: var(--text);
            font-size: 15px;
            resize: none;
            min-height: 45px;
            max-height: 110px;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .file-input {
            display: none;
        }

        .file-btn {
            background: rgba(255, 107, 157, 0.1);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .file-btn:hover {
            background: rgba(255, 107, 157, 0.2);
            transform: scale(1.1);
        }

        .chat-send {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: 0 3px 12px rgba(255, 107, 157, 0.4);
        }

        .chat-send:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 18px rgba(255, 107, 157, 0.6);
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(8px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            margin-left: auto;
        }

        .message.other {
            margin-right: auto;
        }

        .message-bubble {
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 20px 20px 6px 20px;
            box-shadow: 0 3px 12px rgba(255, 107, 157, 0.3);
        }

        .message.other .message-bubble {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            border-radius: 20px 20px 20px 6px;
            border: 1px solid rgba(255, 107, 157, 0.1);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }

        .file-message {
            max-width: 280px;
        }

        .file-preview {
            max-width: 100%;
            max-height: 180px;
            border-radius: 12px;
            margin-bottom: 8px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
        }

        .file-info {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .file-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 13px;
            display: block;
            margin-top: 6px;
            font-weight: 600;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .system-message {
            text-align: center;
            margin: 20px 0;
        }

        .system-bubble {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            display: inline-block;
            max-width: 80%;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Модалка оплаты */
        .payment-modal .modal-content {
            max-width: 480px;
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98), rgba(42, 42, 42, 0.98));
            border: 2px solid var(--primary);
            box-shadow: 0 15px 50px rgba(255, 107, 157, 0.3);
        }

        .crypto-option {
            background: rgba(255, 107, 157, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 107, 157, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .crypto-option:hover {
            background: rgba(255, 107, 157, 0.1);
            border-color: var(--primary);
        }

        .crypto-option.selected {
            background: rgba(255, 107, 157, 0.15);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
        }

        .crypto-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .crypto-icon {
            font-size: 22px;
        }

        .crypto-details h4 {
            margin-bottom: 4px;
            color: var(--text);
        }

        .crypto-details p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .wallet-address {
            background: rgba(255, 107, 157, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin: 12px 0;
            border: 1px solid rgba(255, 107, 157, 0.1);
            font-family: monospace;
            word-break: break-all;
            display: none;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .payment-success {
            text-align: center;
            padding: 35px 15px;
            display: none;
        }

        .success-icon {
            font-size: 3.5rem;
            color: var(--success);
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .payment-timer {
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1), rgba(102, 126, 234, 0.1));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
        }

        .timer-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timer-display {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Courier New', monospace;
        }

        .profile-info-payment {
            background: rgba(255, 107, 157, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 107, 157, 0.1);
        }

        .profile-info-payment h4 {
            margin-bottom: 8px;
            color: var(--primary);
        }

        .profile-details {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .profile-detail {
            background: rgba(255, 107, 157, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            color: var(--primary);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .filters-sidebar {
                width: 100%;
                left: -100%;
            }

            .vip-catalogs-grid {
                grid-template-columns: 1fr;
            }

            .vip-profiles-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }

            .cards-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .container {
                padding: 12px;
            }

            .logo {
                font-size: 2.5rem;
            }

            .header-stats {
                gap: 15px;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            .stats-banner-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .chat-modal {
                height: 85%;
            }

            .slider-main {
                height: 280px;
            }
        }

        @media (max-width: 480px) {
            .vip-profiles-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }

            .card-actions {
                flex-direction: column;
            }

            .filter-actions {
                flex-direction: column;
            }

            .language-btn {
                padding: 8px 12px;
                font-size: 11px;
            }

            .filters-toggle {
                width: 45px;
                height: 45px;
            }

            .slider-main {
                height: 230px;
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s ease;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 8px;
            left: 8px;
            right: 8px;
            background: var(--surface);
            border-top: 1px solid rgba(255, 107, 157, 0.2);
            border-radius: 18px;
            display: flex;
            justify-content: space-around;
            padding: 6px 0;
            z-index: 1000;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
            position: relative;
            text-decoration: none;
            color: var(--text-secondary);
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 22px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
        }

        .nav-badge {
            display: inline-block;
            background: #ff0000;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            font-size: 0;
            margin-left: 3px;
            vertical-align: middle;
        }

        /* Chats Page - исправлено переполнение текста */
        .page {
            display: none;
            padding-bottom: 70px;
        }

        .page.active {
            display: block;
        }

        .chats-list {
            padding: 15px;
        }

        .chat-item {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 107, 157, 0.1);
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
            border-color: var(--primary);
        }

        .chat-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .chat-unread {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 50px 15px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 56px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            font-weight: 600;
        }

        /* Orders Page */
        .orders-list {
            padding: 15px;
        }

        .order-item {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 107, 157, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-status {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }

        .order-status.paid,
        .order-status.booked {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .order-status.unpaid {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .order-status.expired {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .order-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .order-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .order-info {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .container {
            padding-bottom: 70px;
        }

        /* Плавающая кнопка Telegram бота */
        .telegram-bot-btn {
            display: none;
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #0088cc, #00a0dc);
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 15px rgba(0, 136, 204, 0.5);
            z-index: 9999;
            transition: all 0.3s ease;
            border: none;
            animation: floatPulse 3s ease-in-out infinite;
        }

        .telegram-bot-btn:hover {
            transform: scale(1.1) translateY(-4px);
            box-shadow: 0 6px 25px rgba(0, 136, 204, 0.7);
        }

        .telegram-bot-btn:active {
            transform: scale(0.95);
        }

        .telegram-bot-btn svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        @keyframes floatPulse {
            0%, 100% {
                transform: translateY(0px);
                box-shadow: 0 3px 15px rgba(0, 136, 204, 0.5);
            }
            50% {
                transform: translateY(-8px);
                box-shadow: 0 6px 25px rgba(0, 136, 204, 0.7);
            }
        }

        /* Tooltip для кнопки */
        .telegram-bot-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            right: 65px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .telegram-bot-btn:hover::before {
            opacity: 1;
        }

        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            .telegram-bot-btn {
                width: 50px;
                height: 50px;
                bottom: 70px;
                right: 12px;
            }

            .telegram-bot-btn svg {
                width: 25px;
                height: 25px;
            }
        }
    </style>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fuze">
    <meta name="theme-color" content="#ff6b9d">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/icon-76x76.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Анимированный фон -->
    <div class="background-animation"></div>

    <!-- Экран загрузки -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">Fuze</div>
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Loading premium experience...</div>
        </div>
    </div>

    <div class="container" id="main-content">
        <!-- Language and Filters Selector - кнопка фильтров слева -->
        <div class="language-filters-selector">
            <button class="filters-toggle" id="filters-toggle">
                <div class="filter-bar"></div>
                <div class="filter-bar"></div>
                <div class="filter-bar"></div>
            </button>
            <div class="language-selector">
                <button class="language-btn" id="language-btn">
                    <span id="language-text">EN</span>
                </button>
                <div class="language-dropdown" id="language-dropdown">
                    <div class="language-option" data-lang="en">English</div>
                    <div class="language-option" data-lang="ja">日本語</div>
                    <div class="language-option" data-lang="ko">한국어</div>
                    <div class="language-option" data-lang="zh">中文</div>
                    <div class="language-option" data-lang="ar">العربية</div>
                    <div class="language-option" data-lang="de">Deutsch</div>
                    <div class="language-option" data-lang="es">Español</div>
                    <div style="border-top: 1px solid rgba(255, 107, 157, 0.3); margin-top: 6px; padding-top: 6px;">
                        <div class="language-option" id="install-app-btn" onclick="showInstallPrompt(true)" style="color: #ff6b9d; font-weight: 600;">
                            <span id="add-to-screen-text">📱 Add to Screen</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Главный хедер - опущен на 15% -->
        <header class="main-header fade-in">
            <div class="header-content">
                <div class="logo">Fuze</div>
                <div class="subtitle" id="app-subtitle">100% Anonymous Dating</div>

                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="profiles-count">0</span>
                        <span class="stat-label" id="premium-profiles-label">Premium Profiles</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="online-count">0</span>
                        <span class="stat-label" id="online-now-label">Online Now</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">100%</span>
                        <span class="stat-label" id="anonymous-dating-label">Anonymous Dating</span>
                    </div>
                </div>

                <!-- Баннер под статистикой -->
                <div class="stats-banner" id="stats-banner">
                    <div class="stats-banner-content">
                        <span class="stats-banner-text" id="stats-banner-text"></span>
                        <a href="#" class="stats-banner-link" id="stats-banner-link" target="_blank"></a>
                        <button class="close-stats-banner" id="close-stats-banner">✕</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Активные фильтры -->
        <div class="active-filters" id="active-filters"></div>

        <!-- VIP каталоги - 3 анкеты в ряд -->
        <section class="vip-catalogs" id="vip-catalogs">
            <div class="vip-catalogs-grid" id="vip-catalogs-grid">
                <!-- VIP каталоги будут загружены через JS -->
            </div>
        </section>

        <!-- Сетка карточек -->
        <div class="cards-grid" id="cards-container">
            <div class="loading" id="main-loading">
                <div style="font-size: 2.5rem; margin-bottom: 15px;"></div>
                Loading premium profiles...
            </div>
        </div>

        <!-- Кнопка загрузки еще -->
        <div class="loading" id="loading-more" style="display: none;">
            <div id="loading-more-text">Discovering more exclusive matches...</div>
        </div>
    </div>

    <!-- Боковое меню фильтров -->
    <div class="filters-overlay" id="filters-overlay"></div>
    <div class="filters-sidebar" id="filters-sidebar">
        <div class="filters-header">
            <h3 class="filters-title" id="filters-title">Filters</h3>
            <button class="close-btn" id="close-filters">✕</button>
        </div>

        <div class="filters-body">
            <!-- Город -->
            <div class="filter-group">
                <label id="filter-city-label">City</label>
                <div class="city-selector">
                    <select id="filter-city" class="modern-select">
                        <option value="all" id="all-cities">All cities</option>
                    </select>
                </div>
            </div>

            <!-- Национальность -->
            <div class="filter-group">
                <label id="filter-nationality-label">Nationality</label>
                <div class="city-selector">
                    <select id="filter-nationality" class="modern-select">
                        <option value="all" id="all-nationalities">All nationalities</option>
                    </select>
                </div>
            </div>

            <!-- Пол -->
            <div class="filter-group">
                <label id="filter-gender-label">Gender</label>
                <div class="city-selector">
                    <select id="filter-gender" class="modern-select">
                        <option value="all" id="all-genders">All genders</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="transgender">Transgender</option>
                    </select>
                </div>
            </div>

            <!-- Город вылета -->
            <div class="filter-group">
                <label id="filter-travel-city-label">Travel City</label>
                <div class="city-selector">
                    <select id="filter-travel-city" class="modern-select">
                        <option value="all" id="all-travel-cities">All travel cities</option>
                    </select>
                </div>
            </div>

            <!-- Возраст -->
            <div class="filter-group">
                <label id="filter-age-label">Age</label>
                <div class="range-inputs">
                    <input type="number" id="filter-age-min" placeholder="18" min="18" max="70" value="18">
                    <span>-</span>
                    <input type="number" id="filter-age-max" placeholder="70" min="18" max="70" value="70">
                </div>
            </div>

            <!-- Рост -->
            <div class="filter-group">
                <label id="filter-height-label">Height (cm)</label>
                <div class="range-inputs">
                    <input type="number" id="filter-height-min" placeholder="120" min="120" max="220" value="120">
                    <span>-</span>
                    <input type="number" id="filter-height-max" placeholder="220" min="120" max="220" value="220">
                </div>
            </div>

            <!-- Вес -->
            <div class="filter-group">
                <label id="filter-weight-label">Weight (kg)</label>
                <div class="range-inputs">
                    <input type="number" id="filter-weight-min" placeholder="35" min="35" max="120" value="35">
                    <span>-</span>
                    <input type="number" id="filter-weight-max" placeholder="120" min="35" max="120" value="120">
                </div>
            </div>

            <!-- Грудь -->
            <div class="filter-group">
                <label id="filter-chest-label">Chest</label>
                <div class="range-inputs">
                    <input type="number" id="filter-chest-min" placeholder="1" min="1" max="12" value="1">
                    <span>-</span>
                    <input type="number" id="filter-chest-max" placeholder="12" min="1" max="12" value="12">
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-secondary" id="reset-filters">
                    <span id="reset-text">Reset</span>
                </button>
                <button class="btn btn-primary" id="apply-filters">
                    <span id="apply-text">Apply</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно профиля -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-profile-name">Profile Name</h2>
                <button class="close-btn" id="close-modal">✕</button>
            </div>
            <div class="modal-body">
                <!-- Слайдер фото -->
                <div class="slider" id="profile-slider">
                    <div class="slider-main" id="slider-main">
                        <!-- Фото будут добавлены через JS -->
                    </div>
                    <div class="slider-nav">
                        <button class="slider-btn" id="prev-slide">‹</button>
                        <button class="slider-btn" id="next-slide">›</button>
                    </div>
                    <div class="slider-thumbs" id="slider-thumbs"></div>
                </div>

                <div class="profile-stats-modal">
                    <div class="stat-badge"><span id="modal-profile-age">25</span> <span id="years-text">years</span></div>
                    <div class="stat-badge"><span id="modal-profile-height">170</span> <span id="cm-text">cm</span></div>
                    <div class="stat-badge"><span id="modal-profile-weight">55</span> <span id="kg-text">kg</span></div>
                    <div class="stat-badge"><span id="modal-profile-chest">3</span> chest</div>
                </div>

                <div class="profile-info">
                    <div class="info-item">
                        <span class="info-icon" id="label-gender">Gender:</span>
                        <span id="modal-profile-gender"> </span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon" id="label-city">City:</span>
                        <span id="modal-profile-city"> </span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon" id="label-nationality">Nationality:</span>
                        <span id="modal-profile-nationality"> </span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon" id="label-travel-cities">Travel Cities:</span>
                        <span id="modal-profile-travel-cities"> </span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon" id="label-description">Description:</span>
                        <span id="modal-profile-description"> </span>
                    </div>
                </div>

                <!-- Комментарии -->
                <div class="comments-section">
                    <h3 class="comments-title" id="comments-title">Comments</h3>

                    <!-- Форма добавления комментария -->
                    <div class="comment-form" id="comment-form">
                        <textarea class="comment-input" id="comment-input" placeholder="Your comment..."></textarea>
                        <button class="btn btn-primary" id="post-comment-btn">
                            <span id="post-comment-text">Post Comment</span>
                        </button>
                    </div>

                    <!-- Сообщение о необходимости транзакции -->
                    <div class="comment-permission-required" id="comment-permission-required">
                        <div class="comment-permission-text" id="comment-permission-text">
                            To leave comments, you need to use our services first
                        </div>
                        <button class="btn btn-primary" onclick="openPaymentModal()">
                            <span id="complete-transaction-text">Complete Transaction</span>
                        </button>
                    </div>

                    <!-- Список комментариев -->
                    <div class="comments-list" id="comments-list">
                        <div class="no-comments" id="no-comments">No comments yet</div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="btn btn-primary" id="write-btn">
                        <span id="write-text">Write Message</span>
                    </button>
                    <button class="btn btn-pay" id="pay-btn">
                        <span id="pay-text">Book with Crypto</span>
                    </button>
                    <button class="btn btn-promo" id="promo-btn">
                        <span id="promo-text">Use Promo Code</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно промокода -->
    <div class="modal promo-modal" id="promo-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Promo Code</h2>
                <button class="close-btn" id="close-promo">✕</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: var(--text-secondary);" id="promo-description">
                    Enter your promo code to get a special discount
                </p>
                <div class="promo-input-group">
                    <input type="text" class="promo-input" id="promo-input" placeholder="Enter promo code">
                    <button class="btn btn-primary" id="apply-promo">
                        <span id="apply-promo-text">Apply</span>
                    </button>
                </div>
                <div class="promo-result" id="promo-result"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" id="close-promo-btn">
                        <span id="close-promo-text">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно оплаты -->
    <div class="modal payment-modal" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Crypto Payment</h2>
                <button class="close-btn" id="close-payment">✕</button>
            </div>
            <div class="modal-body" id="payment-body">
                <div id="payment-selection">
                    <!-- Информация о профиле -->
                    <div class="profile-info-payment">
                        <h4 id="payment-profile-title">Booking Profile</h4>
                        <div class="profile-details">
                            <span class="profile-detail" id="payment-profile-name">Name: </span>
                            <span class="profile-detail" id="payment-profile-age">Age: </span>
                            <span class="profile-detail" id="payment-profile-gender">Gender: </span>
                            <span class="profile-detail" id="payment-profile-city">City: </span>
                        </div>
                    </div>

                    <p style="margin-bottom: 15px; color: var(--text-secondary);" id="payment-description">Select cryptocurrency and enter amount</p>

                    <div class="form-group">
                        <label id="payment-amount-label">Amount (USD)</label>
                        <input type="number" id="payment-amount" class="modern-select" placeholder="100" min="10" value="100">
                    </div>

                    <div class="crypto-option" data-crypto="trc20">
                        <div class="crypto-info">
                            <div class="crypto-icon">₿</div>
                            <div class="crypto-details">
                                <h4>USDT (TRC20)</h4>
                                <p>Fast transactions, low fees</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="erc20">
                        <div class="crypto-info">
                            <div class="crypto-icon">Ξ</div>
                            <div class="crypto-details">
                                <h4>USDT (ERC20)</h4>
                                <p>Ethereum network</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="bnb">
                        <div class="crypto-info">
                            <div class="crypto-icon">◆</div>
                            <div class="crypto-details">
                                <h4>BNB (BEP20)</h4>
                                <p>Binance Smart Chain</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="btc">
                        <div class="crypto-info">
                            <div class="crypto-icon">₿</div>
                            <div class="crypto-details">
                                <h4>Bitcoin (BTC)</h4>
                                <p>Original cryptocurrency</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="zetcash">
                        <div class="crypto-info">
                            <div class="crypto-icon">Ƶ</div>
                            <div class="crypto-details">
                                <h4>ZetCash</h4>
                                <p>Privacy focused</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="doge">
                        <div class="crypto-info">
                            <div class="crypto-icon">Ð</div>
                            <div class="crypto-details">
                                <h4>Dogecoin (DOGE)</h4>
                                <p>Much wow, very coin</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="dash">
                        <div class="crypto-info">
                            <div class="crypto-icon">Đ</div>
                            <div class="crypto-details">
                                <h4>Dash (DASH)</h4>
                                <p>Digital cash</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="ltc">
                        <div class="crypto-info">
                            <div class="crypto-icon">Ł</div>
                            <div class="crypto-details">
                                <h4>Litecoin (LTC)</h4>
                                <p>Silver to Bitcoin's gold</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="usdt_bep20">
                        <div class="crypto-info">
                            <div class="crypto-icon">₮</div>
                            <div class="crypto-details">
                                <h4>USDT (BEP20)</h4>
                                <p>Binance Smart Chain</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="eth">
                        <div class="crypto-info">
                            <div class="crypto-icon">Ξ</div>
                            <div class="crypto-details">
                                <h4>Ethereum (ETH)</h4>
                                <p>Smart contract platform</p>
                            </div>
                        </div>
                    </div>

                    <div class="crypto-option" data-crypto="usdc_erc20">
                        <div class="crypto-info">
                            <div class="crypto-icon">$</div>
                            <div class="crypto-details">
                                <h4>USDC (ERC20)</h4>
                                <p>USD stablecoin</p>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 12px; background: rgba(255, 107, 157, 0.1); border-radius: 10px; margin: 12px 0; text-align: center;">
                        <span style="color: var(--primary); font-weight: 600;">🎁 +5% Bonus on all deposits!</span>
                    </div>

                    <button class="btn btn-primary" id="confirm-payment" style="width: 100%; margin-top: 15px;">
                        <span id="confirm-payment-text">Pay</span>
                    </button>
                </div>

                <div class="payment-success" id="payment-success">
                    <div class="success-icon">⏳</div>
                    <h3 id="payment-success-title">Awaiting Confirmation</h3>
                    <p id="payment-success-message">Processing payment... Close the window, you will receive a notification in chat.</p>

                    <div style="margin: 15px 0; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <div style="margin-bottom: 8px;">
                            <strong>Cryptocurrency:</strong> <span id="selected-crypto-type">-</span>
                        </div>
                        <div>
                            <strong>Amount:</strong> $<span id="selected-amount">-</span>
                        </div>
                    </div>

                    <div class="wallet-address" id="wallet-address" style="margin: 15px 0;">
                        <strong id="wallet-address-label">Wallet Address:</strong>
                        <div id="address-text" style="margin: 8px 0; word-break: break-all; background: rgba(255,107,157,0.1); padding: 12px; border-radius: 6px; font-size: 13px;"></div>
                        <button class="copy-btn" id="copy-address" style="margin-top: 8px;">Copy Address</button>
                    </div>

                    <div class="payment-timer">
                        <div class="timer-label" id="timer-label">Time remaining:</div>
                        <div class="timer-display" id="timer-display">60:00</div>
                    </div>
                    <button class="btn btn-primary" id="close-success">
                        <span id="close-success-text">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно чата -->
    <div class="chat-modal" id="chat-modal">
        <div class="chat-header">
            <h3 class="chat-title">
                <img src="" alt="Profile" class="chat-avatar" id="chat-avatar">
                <span id="chat-title-text">Chat with ...</span>
            </h3>
            <button class="close-btn" id="close-chat">✕</button>
        </div>
        <div class="chat-warning" id="chat-warning"></div>
        <div class="chat-body" id="chat-body"></div>
        <div class="chat-footer">
            <input type="file" class="file-input" id="file-input" accept="image/*,video/*,.pdf,.doc,.docx">
            <button class="file-btn" id="file-btn">
                <span id="attach-file-text">📎</span>
            </button>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chat-input" placeholder="Type a message..." rows="1"></textarea>
            </div>
            <button class="chat-send" id="chat-send">➤</button>
        </div>
    </div>

    <!-- Pages Container -->
    <div id="pages-container">
        <!-- Home/Profiles Page -->
        <div id="home-page" class="page active">
            <!-- Main content already here -->
        </div>

        <!-- Chats Page - исправлено переполнение текста -->
        <div id="chats-page" class="page">
            <header class="main-header">
                <h2 style="color: var(--primary); font-size: 22px; font-weight: 700;">My Chats</h2>
            </header>
            <div class="chats-list" id="chats-list-container"></div>
        </div>

        <!-- My Bookings Page -->
        <div id="paid-orders-page" class="page">
            <header class="main-header">
                <h2 style="color: #28a745; font-size: 22px; font-weight: 700;">My Bookings</h2>
            </header>
            <div class="orders-list" id="paid-orders-list"></div>
        </div>

        <!-- Pending Orders Page -->
        <div id="unpaid-orders-page" class="page">
            <header class="main-header">
                <h2 style="color: #ffc107; font-size: 22px; font-weight: 700;">Pending Orders</h2>
            </header>
            <div class="orders-list" id="unpaid-orders-list"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')">
            <div class="nav-label" id="nav-home-label">Home</div>
        </div>
        <div class="nav-item" onclick="switchPage('chats')">
            <div class="nav-label" id="nav-chats-label">Chats<span class="nav-badge" id="chats-badge" style="display: none;"></span></div>
        </div>
        <div class="nav-item" onclick="switchPage('paid')">
            <div class="nav-label" id="nav-paid-label">My Bookings<span class="nav-badge" id="booked-badge" style="display: none;"></span></div>
        </div>
        <div class="nav-item" onclick="switchPage('unpaid')">
            <div class="nav-label" id="nav-unpaid-label">Pending<span class="nav-badge" id="unpaid-badge" style="display: none;"></span></div>
        </div>
    </div>

    <script>
        // ==================== TELEGRAM WEB APP ====================
        let tg = null;
        let telegramUser = null;

        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();

            // Получаем данные пользователя
            telegramUser = tg.initDataUnsafe?.user;

            // DEBUG: Логируем все данные Telegram
            console.log('=== TELEGRAM DEBUG ===');
            console.log('tg.initData:', tg.initData);
            console.log('tg.initDataUnsafe:', tg.initDataUnsafe);
            console.log('telegramUser:', telegramUser);
            console.log('======================');

            // Устанавливаем тему
            if (tg.themeParams) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#0f0f0f');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#ffffff');
            }

            console.log('Telegram Web App initialized', telegramUser);
        }

        // ==================== TELEGRAM AUTHENTICATION ====================
        // Сохраняем оригинальный fetch
        const originalFetch = window.fetch;

        // Функция аутентификации через Telegram WebApp
        async function authenticateWithTelegram() {
            console.log('=== AUTHENTICATION DEBUG ===');
            console.log('tg:', tg);
            console.log('tg?.initData:', tg?.initData);
            console.log('============================');

            if (!tg || !tg.initData) {
                console.warn('⚠️ Telegram WebApp initData not available, skipping authentication');
                console.warn('   tg exists:', !!tg);
                console.warn('   tg.initData exists:', !!tg?.initData);
                console.warn('   tg.initData value:', tg?.initData);
                return false;
            }

            try {
                console.log('🔐 Authenticating with Telegram...');
                const response = await originalFetch('/api/telegram/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Telegram authentication successful', data);
                    return true;
                } else {
                    const error = await response.json();
                    console.error('❌ Telegram authentication failed:', response.status, error);
                    return false;
                }
            } catch (error) {
                console.error('❌ Error during Telegram authentication:', error);
                return false;
            }
        }

        // Переопределяем fetch для автоматического включения credentials
        window.fetch = function(...args) {
            const [url, options = {}] = args;

            // Автоматически добавляем credentials: 'include' для всех запросов
            const newOptions = {
                ...options,
                credentials: 'include'
            };

            return originalFetch(url, newOptions);
        };

        // Helper function to get telegram_user_id for API calls
        function getTelegramUserId() {
            return telegramUser?.id ? String(telegramUser.id) : null;
        }

        // ==================== SECURITY: XSS PROTECTION ====================
        /**
         * Escapes HTML to prevent XSS attacks
         * Use this function for ALL user-generated content before inserting into DOM
         */
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) {
                return '';
            }
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        /**
         * Safely set text content (preferred method)
         * Use textContent instead of innerHTML when no HTML formatting is needed
         */
        function safeSetText(element, text) {
            element.textContent = text || '';
        }

        /**
         * Safely set HTML with escaped content
         * Use this when you need to build HTML templates with user data
         */
        function safeSetHtml(element, htmlTemplate) {
            element.innerHTML = htmlTemplate;
        }

        // Helper function to add telegram_user_id to URL
        function addTelegramUserParam(url) {
            const userId = getTelegramUserId();
            if (!userId) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}telegram_user_id=${userId}`;
        }

        // ==================== PWA INSTALLATION ====================
        let deferredPrompt;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

        // Обработчик события установки PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Автоматический показ баннера отключен
            // Пользователь может вручную установить приложение через меню языков
        });

        function showInstallPrompt(force = false) {
            if (isStandalone) {
                // Если уже установлено, показываем сообщение
                alert(translations.app_already_installed || 'App is already installed on your device!');
                return;
            }

            // Закрываем dropdown языков если он открыт
            const languageDropdown = document.getElementById('language-dropdown');
            if (languageDropdown) languageDropdown.classList.remove('active');

            // Сразу вызываем установку без баннера
            installPWA();
        }

        async function installPWA() {
            if (isIOS) {
                showIOSInstructions();
                return;
            }

            if (!deferredPrompt) {
                alert(translations.install_unavailable || 'Installation unavailable. Try opening the site in a browser.');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('Install outcome:', outcome);

            if (outcome === 'accepted') {
                console.log('✅ Приложение добавлено на домашний экран');
            }

            deferredPrompt = null;
        }

        function showIOSInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10001; padding: 15px;';
            modal.innerHTML = `
                <div style="background: #1a1a1a; border-radius: 18px; padding: 25px; max-width: 380px; text-align: center; border: 1px solid #ff6b9d;">
                    <h3 style="color: #ff6b9d; margin-bottom: 15px; font-size: 18px;">${translations.ios_add_title || 'Add to Home Screen'}</h3>
                    <ol style="text-align: left; color: white; line-height: 1.8; padding-left: 15px;">
                        <li>${translations.ios_step1 || 'Tap the Share button'} <span style="font-size: 22px;">⎋</span></li>
                        <li>${translations.ios_step2 || 'Select "Add to Home Screen"'} <span style="font-size: 22px;">➕</span></li>
                        <li>${translations.ios_step3 || 'Tap "Add"'}</li>
                    </ol>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: linear-gradient(135deg, #ff6b9d, #667eea); color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 15px; cursor: pointer; font-weight: 600;">${translations.ios_got_it || 'Got it'}</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Автоматический показ промпта для iOS отключен
        // Пользователь может вручную установить приложение через меню языков

        // ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        // Глобальные переменные
        let currentProfiles = [];
        let currentPage = 0;
        let isLoading = false;
        let currentProfile = null;
        let currentSlideIndex = 0;
        const profilesPerPage = 20;
        let onlineCount = 0;
        let onlineUpdateInterval = null;

        // Переменные для авто-обновления чата
        let chatUpdateInterval = null;
        let lastMessageId = 0;
        let canComment = false; // Может ли пользователь оставлять комментарии

        // VIP каталоги
        let vipCatalogs = {};

        // Фильтры
        let currentFilters = {
            city: 'all',
            nationality: 'all',
            travel_city: 'all',
            gender: 'all',
            age_min: 18,
            age_max: 70,
            height_min: 120,
            height_max: 220,
            weight_min: 35,
            weight_max: 120,
            chest_min: 1,
            chest_max: 12
        };

        // Текущий язык
        let currentLanguage = 'en';

        // Все переводы
        const allTranslations = {
            en: {
                subtitle: "100% Anonymous Dating",
                premium_profiles: "Premium Profiles",
                online_now: "Online Now",
                anonymous_dating: "Anonymous Dating",
                filters: "Filters",
                city: "City",
                all_cities: "All Cities",
                nationality: "Nationality",
                all_nationalities: "All Nationalities",
                gender: "Gender",
                all_genders: "All",
                travel_city: "Travel City",
                age: "Age",
                height: "Height (cm)",
                weight: "Weight (kg)",
                chest: "Chest",
                reset: "Reset",
                apply: "Apply",
                loading: "Loading...",
                loading_more: "Loading more...",
                view_profile: "More",
                write_message: "Write",
                book_with_crypto: "Pay",
                promocode: "Promo",
                years: "years",
                cm: "cm",
                kg: "kg",
                chest_size: "chest",
                apply_promocode: "Apply",
                close: "Close",
                error_sending: "Error sending message",
                enter_promocode: "Enter promocode to get discount",
                comments: "Comments",
                post_comment: "Post Comment",
                no_comments: "No comments yet",
                your_comment: "Your comment...",
                pay_now: "Confirm Payment",
                amount: "Amount:",
                select_crypto: "Select cryptocurrency:",
                wallet_address: "Wallet Address:",
                booking_profile: "Booking Profile:",
                payment_awaiting: "Payment Processing",
                payment_processing: "Your payment is being processed. Please wait...",
                timer_label: "Time remaining",
                chat_with: "Chat with",
                attach_file: "📎",
                comment_permission_required: "Payment required",
                complete_transaction_to_comment: "Complete payment to leave comments",
                type_message: "Type a message...",
                chat_warning: "Do not share contacts from other messengers. This is for the model's safety.",
                female: "Female",
                male: "Male",
                transgender: "Transgender",
                description: "Description",
                vip_catalog: "VIP Catalog",
                extra_vip: "Extra VIP",
                secret_catalog: "Secret Catalog",
                label_gender: "Gender:",
                label_city: "City:",
                label_nationality: "Nationality:",
                label_travel_cities: "Travel Cities:",
                label_description: "Description:",
                // Navigation
                nav_home: "Home",
                nav_chats: "Chats",
                nav_my_bookings: "My Bookings",
                nav_pending: "Pending",
                // Page titles
                page_my_chats: "My Chats",
                page_my_bookings: "My Bookings",
                page_pending_orders: "Pending Orders",
                // Loading states
                loading_premium: "Loading premium experience...",
                loading_chats: "Loading chats...",
                loading_orders: "Loading orders...",
                // Empty states
                no_chats: "No chats yet",
                no_orders: "No orders",
                no_booked_orders: "No booked orders",
                no_unpaid_orders: "No pending orders",
                // Order statuses
                order_pending: "Pending",
                order_confirmed: "Confirmed",
                order_expired: "Expired",
                booking_confirmed: "Booking Confirmed",
                booking_expired: "Booking Expired",
                // Errors
                error_loading_profile: "Error loading profile",
                error_loading_chats: "Error loading chats",
                error_loading_orders: "Error loading orders",
                error_payment: "Payment error",
                error_adding_comment: "Error adding comment",
                // Alerts
                alert_enter_comment: "Please enter comment text",
                alert_payment_expired: "Payment time has expired",
                alert_select_crypto: "Please select cryptocurrency",
                alert_min_amount: "Please enter valid amount (min $10)",
                alert_profile_not_found: "Profile not found",
                // Order details
                order_number: "Order",
                order_amount: "Amount",
                order_date: "Date",
                order_crypto: "Crypto",
                // PWA
                add_to_homescreen: "Add to Home Screen",
                add_to_screen: "📱 Add to Screen",
                ios_add_title: "Add to Home Screen",
                ios_step1: "Tap the Share button",
                ios_step2: "Select \"Add to Home Screen\"",
                ios_step3: "Tap \"Add\"",
                ios_got_it: "Got it",
                // Misc
                anonymous_user: "Anonymous User",
                no_profiles: "No profiles found",
                promocode_invalid: "Invalid promo code",
                download: "Download",
                copied: "Copied to clipboard",
                unlock_access: "Unlock Access",
                profiles_count: "profiles",
                // Payment modal labels
                payment_name: "Name:",
                payment_age: "Age:",
                payment_gender: "Gender:",
                payment_city: "City:",
                unknown: "Unknown",
                app_already_installed: "App is already installed on your device!",
                install_unavailable: "Installation unavailable. Try opening the site in a browser."
            },
            es: {
                subtitle: "100% Citas Anónimas",
                premium_profiles: "Perfiles Premium",
                online_now: "En línea ahora",
                anonymous_dating: "Citas Anónimas",
                filters: "Filtros",
                city: "Ciudad",
                all_cities: "Todas las ciudades",
                nationality: "Nacionalidad",
                all_nationalities: "Todas las nacionalidades",
                gender: "Género",
                all_genders: "Todos",
                travel_city: "Ciudad de viaje",
                age: "Edad",
                height: "Altura (cm)",
                weight: "Peso (kg)",
                chest: "Pecho",
                reset: "Restablecer",
                apply: "Aplicar",
                loading: "Cargando...",
                loading_more: "Cargando más...",
                view_profile: "Más",
                write_message: "Escribir",
                book_with_crypto: "Pagar",
                promocode: "Código promocional",
                years: "años",
                cm: "cm",
                kg: "kg",
                chest_size: "pecho",
                apply_promocode: "Aplicar",
                close: "Cerrar",
                error_sending: "Error al enviar mensaje",
                enter_promocode: "Ingrese el código promocional para obtener descuento",
                comments: "Comentarios",
                post_comment: "Publicar comentario",
                no_comments: "Aún no hay comentarios",
                your_comment: "Tu comentario...",
                pay_now: "Confirmar pago",
                amount: "Cantidad:",
                select_crypto: "Selecciona criptomoneda:",
                wallet_address: "Dirección de billetera:",
                booking_profile: "Reserva de perfil:",
                payment_awaiting: "Procesando pago",
                payment_processing: "Tu pago está siendo procesado. Por favor espera...",
                timer_label: "Tiempo restante",
                chat_with: "Chat con",
                attach_file: "📎",
                comment_permission_required: "Pago requerido",
                complete_transaction_to_comment: "Completa el pago para dejar comentarios",
                type_message: "Escribe un mensaje...",
                chat_warning: "No compartas contactos de otros mensajeros. Esto es para la seguridad del modelo.",
                female: "Mujer",
                male: "Hombre",
                transgender: "Transgénero",
                description: "Descripción",
                vip_catalog: "Catálogo VIP",
                extra_vip: "Extra VIP",
                secret_catalog: "Catálogo Secreto",
                label_gender: "Género:",
                label_city: "Ciudad:",
                label_nationality: "Nacionalidad:",
                label_travel_cities: "Ciudades de viaje:",
                label_description: "Descripción:",
                nav_home: "Inicio",
                nav_chats: "Chats",
                nav_my_bookings: "Mis Reservas",
                nav_pending: "Pendiente",
                page_my_chats: "Mis Chats",
                page_my_bookings: "Mis Reservas",
                page_pending_orders: "Pedidos Pendientes",
                loading_premium: "Cargando experiencia premium...",
                loading_chats: "Cargando chats...",
                loading_orders: "Cargando pedidos...",
                no_chats: "Aún no hay chats",
                no_orders: "Sin pedidos",
                no_booked_orders: "Sin reservas confirmadas",
                no_unpaid_orders: "Sin pedidos pendientes",
                order_pending: "Pendiente",
                order_confirmed: "Confirmado",
                order_expired: "Expirado",
                booking_confirmed: "Reserva Confirmada",
                booking_expired: "Reserva Expirada",
                error_loading_profile: "Error al cargar perfil",
                error_loading_chats: "Error al cargar chats",
                error_loading_orders: "Error al cargar pedidos",
                error_payment: "Error de pago",
                error_adding_comment: "Error al agregar comentario",
                alert_enter_comment: "Por favor ingrese el texto del comentario",
                alert_payment_expired: "El tiempo de pago ha expirado",
                alert_select_crypto: "Por favor seleccione criptomoneda",
                alert_min_amount: "Ingrese un monto válido (mín $10)",
                alert_profile_not_found: "Perfil no encontrado",
                order_number: "Pedido",
                order_amount: "Monto",
                order_date: "Fecha",
                order_crypto: "Cripto",
                add_to_homescreen: "Agregar a Inicio",
                anonymous_user: "Usuario Anónimo",
                add_to_screen: "📱 Añadir a pantalla",
                ios_add_title: "Añadir a pantalla de inicio",
                ios_step1: "Toca el botón Compartir",
                ios_step2: "Selecciona \"Añadir a pantalla de inicio\"",
                ios_step3: "Toca \"Añadir\"",
                ios_got_it: "Entendido",
                no_profiles: "No se encontraron perfiles",
                promocode_invalid: "Código promocional inválido",
                download: "Descargar",
                copied: "Copiado al portapapeles",
                unlock_access: "Desbloquear acceso",
                profiles_count: "perfiles",
                payment_name: "Nombre:",
                payment_age: "Edad:",
                payment_gender: "Género:",
                payment_city: "Ciudad:",
                unknown: "Desconocido",
                app_already_installed: "¡La app ya está instalada en tu dispositivo!",
                install_unavailable: "Instalación no disponible. Intenta abrir el sitio en un navegador."
            },
            ar: {
                subtitle: "مواعدة مجهولة 100%",
                premium_profiles: "ملفات تعريف مميزة",
                online_now: "متصل الآن",
                anonymous_dating: "مواعدة مجهولة",
                filters: "المرشحات",
                city: "المدينة",
                all_cities: "كل المدن",
                nationality: "الجنسية",
                all_nationalities: "كل الجنسيات",
                gender: "الجنس",
                all_genders: "الكل",
                travel_city: "مدينة السفر",
                age: "العمر",
                height: "الطول (سم)",
                weight: "الوزن (كجم)",
                chest: "الصدر",
                reset: "إعادة تعيين",
                apply: "تطبيق",
                loading: "جاري التحميل...",
                loading_more: "تحميل المزيد...",
                view_profile: "المزيد",
                write_message: "كتابة",
                book_with_crypto: "الدفع",
                promocode: "رمز ترويجي",
                years: "سنة",
                cm: "سم",
                kg: "كجم",
                chest_size: "صدر",
                apply_promocode: "تطبيق",
                close: "إغلاق",
                error_sending: "خطأ في إرسال الرسالة",
                enter_promocode: "أدخل الرمز الترويجي للحصول على خصم",
                comments: "التعليقات",
                post_comment: "نشر تعليق",
                no_comments: "لا توجد تعليقات بعد",
                your_comment: "تعليقك...",
                pay_now: "تأكيد الدفع",
                amount: "المبلغ:",
                select_crypto: "اختر العملة المشفرة:",
                wallet_address: "عنوان المحفظة:",
                booking_profile: "حجز الملف الشخصي:",
                payment_awaiting: "معالجة الدفع",
                payment_processing: "جاري معالجة دفعتك. يرجى الانتظار...",
                timer_label: "الوقت المتبقي",
                chat_with: "الدردشة مع",
                attach_file: "📎",
                comment_permission_required: "الدفع مطلوب",
                complete_transaction_to_comment: "أكمل الدفع لترك التعليقات",
                type_message: "اكتب رسالة...",
                chat_warning: "لا تشارك جهات الاتصال من تطبيقات المراسلة الأخرى. هذا من أجل سلامة النموذج.",
                female: "أنثى",
                male: "ذكر",
                transgender: "متحول جنسياً",
                description: "الوصف",
                vip_catalog: "كتالوج VIP",
                extra_vip: "Extra VIP",
                secret_catalog: "كتالوج سري",
                label_gender: ":الجنس",
                label_city: ":المدينة",
                label_nationality: ":الجنسية",
                label_travel_cities: ":مدن السفر",
                label_description: ":الوصف",
                nav_home: "الرئيسية",
                nav_chats: "الدردشات",
                nav_my_bookings: "حجوزاتي",
                nav_pending: "معلق",
                page_my_chats: "دردشاتي",
                page_my_bookings: "حجوزاتي",
                page_pending_orders: "الطلبات المعلقة",
                loading_premium: "جاري تحميل التجربة المميزة...",
                loading_chats: "جاري تحميل الدردشات...",
                loading_orders: "جاري تحميل الطلبات...",
                no_chats: "لا توجد دردشات بعد",
                no_orders: "لا توجد طلبات",
                no_booked_orders: "لا توجد حجوزات مؤكدة",
                no_unpaid_orders: "لا توجد طلبات معلقة",
                order_pending: "معلق",
                order_confirmed: "مؤكد",
                order_expired: "منتهي",
                booking_confirmed: "تم تأكيد الحجز",
                booking_expired: "انتهى الحجز",
                error_loading_profile: "خطأ في تحميل الملف الشخصي",
                error_loading_chats: "خطأ في تحميل الدردشات",
                error_loading_orders: "خطأ في تحميل الطلبات",
                error_payment: "خطأ في الدفع",
                error_adding_comment: "خطأ في إضافة التعليق",
                alert_enter_comment: "يرجى إدخال نص التعليق",
                alert_payment_expired: "انتهى وقت الدفع",
                alert_select_crypto: "يرجى اختيار العملة المشفرة",
                alert_min_amount: "يرجى إدخال مبلغ صالح (الحد الأدنى 10$)",
                alert_profile_not_found: "الملف الشخصي غير موجود",
                order_number: "الطلب",
                order_amount: "المبلغ",
                order_date: "التاريخ",
                order_crypto: "العملة",
                add_to_homescreen: "إضافة للشاشة الرئيسية",
                anonymous_user: "مستخدم مجهول",
                add_to_screen: "📱 إضافة إلى الشاشة",
                ios_add_title: "إضافة إلى الشاشة الرئيسية",
                ios_step1: "اضغط على زر المشاركة",
                ios_step2: "اختر \"إضافة إلى الشاشة الرئيسية\"",
                ios_step3: "اضغط \"إضافة\"",
                ios_got_it: "فهمت",
                no_profiles: "لم يتم العثور على ملفات",
                promocode_invalid: "رمز ترويجي غير صالح",
                download: "تحميل",
                copied: "تم النسخ",
                unlock_access: "فتح الوصول",
                profiles_count: "ملفات",
                payment_name: ":الاسم",
                payment_age: ":العمر",
                payment_gender: ":الجنس",
                payment_city: ":المدينة",
                unknown: "غير معروف",
                app_already_installed: "!التطبيق مثبت بالفعل على جهازك",
                install_unavailable: "التثبيت غير متاح. حاول فتح الموقع في متصفح."
            },
            de: {
                subtitle: "100% Anonymes Dating",
                premium_profiles: "Premium-Profile",
                online_now: "Jetzt online",
                anonymous_dating: "Anonymes Dating",
                filters: "Filter",
                city: "Stadt",
                all_cities: "Alle Städte",
                nationality: "Nationalität",
                all_nationalities: "Alle Nationalitäten",
                gender: "Geschlecht",
                all_genders: "Alle",
                travel_city: "Reisestadt",
                age: "Alter",
                height: "Größe (cm)",
                weight: "Gewicht (kg)",
                chest: "Brust",
                reset: "Zurücksetzen",
                apply: "Anwenden",
                loading: "Wird geladen...",
                loading_more: "Mehr laden...",
                view_profile: "Mehr",
                write_message: "Schreiben",
                book_with_crypto: "Bezahlen",
                promocode: "Promocode",
                years: "Jahre",
                cm: "cm",
                kg: "kg",
                chest_size: "Brust",
                apply_promocode: "Anwenden",
                close: "Schließen",
                error_sending: "Fehler beim Senden der Nachricht",
                enter_promocode: "Promocode eingeben für Rabatt",
                comments: "Kommentare",
                post_comment: "Kommentar posten",
                no_comments: "Noch keine Kommentare",
                your_comment: "Dein Kommentar...",
                pay_now: "Zahlung bestätigen",
                amount: "Betrag:",
                select_crypto: "Kryptowährung auswählen:",
                wallet_address: "Wallet-Adresse:",
                booking_profile: "Profil buchen:",
                payment_awaiting: "Zahlungsabwicklung",
                payment_processing: "Deine Zahlung wird bearbeitet. Bitte warten...",
                timer_label: "Verbleibende Zeit",
                chat_with: "Chat mit",
                attach_file: "📎",
                comment_permission_required: "Zahlung erforderlich",
                complete_transaction_to_comment: "Schließe die Zahlung ab, um Kommentare zu hinterlassen",
                type_message: "Nachricht eingeben...",
                chat_warning: "Teilen Sie keine Kontakte aus anderen Messengern. Dies dient der Sicherheit des Modells.",
                female: "Weiblich",
                male: "Männlich",
                transgender: "Transgender",
                description: "Beschreibung",
                vip_catalog: "VIP-Katalog",
                extra_vip: "Extra VIP",
                secret_catalog: "Geheimer Katalog",
                label_gender: "Geschlecht:",
                label_city: "Stadt:",
                label_nationality: "Nationalität:",
                label_travel_cities: "Reisestädte:",
                label_description: "Beschreibung:",
                nav_home: "Startseite",
                nav_chats: "Chats",
                nav_my_bookings: "Meine Buchungen",
                nav_pending: "Ausstehend",
                page_my_chats: "Meine Chats",
                page_my_bookings: "Meine Buchungen",
                page_pending_orders: "Ausstehende Bestellungen",
                loading_premium: "Lade Premium-Erfahrung...",
                loading_chats: "Lade Chats...",
                loading_orders: "Lade Bestellungen...",
                no_chats: "Noch keine Chats",
                no_orders: "Keine Bestellungen",
                no_booked_orders: "Keine bestätigten Buchungen",
                no_unpaid_orders: "Keine ausstehenden Bestellungen",
                order_pending: "Ausstehend",
                order_confirmed: "Bestätigt",
                order_expired: "Abgelaufen",
                booking_confirmed: "Buchung Bestätigt",
                booking_expired: "Buchung Abgelaufen",
                error_loading_profile: "Fehler beim Laden des Profils",
                error_loading_chats: "Fehler beim Laden der Chats",
                error_loading_orders: "Fehler beim Laden der Bestellungen",
                error_payment: "Zahlungsfehler",
                error_adding_comment: "Fehler beim Hinzufügen des Kommentars",
                alert_enter_comment: "Bitte Kommentartext eingeben",
                alert_payment_expired: "Zahlungszeit abgelaufen",
                alert_select_crypto: "Bitte Kryptowährung auswählen",
                alert_min_amount: "Bitte gültigen Betrag eingeben (min. $10)",
                alert_profile_not_found: "Profil nicht gefunden",
                order_number: "Bestellung",
                order_amount: "Betrag",
                order_date: "Datum",
                order_crypto: "Krypto",
                add_to_homescreen: "Zum Startbildschirm",
                anonymous_user: "Anonymer Benutzer",
                add_to_screen: "📱 Zum Bildschirm hinzufügen",
                ios_add_title: "Zum Startbildschirm hinzufügen",
                ios_step1: "Tippen Sie auf die Teilen-Schaltfläche",
                ios_step2: "Wählen Sie \"Zum Startbildschirm\"",
                ios_step3: "Tippen Sie auf \"Hinzufügen\"",
                ios_got_it: "Verstanden",
                no_profiles: "Keine Profile gefunden",
                promocode_invalid: "Ungültiger Promo-Code",
                download: "Herunterladen",
                copied: "In die Zwischenablage kopiert",
                unlock_access: "Zugang freischalten",
                profiles_count: "Profile",
                payment_name: "Name:",
                payment_age: "Alter:",
                payment_gender: "Geschlecht:",
                payment_city: "Stadt:",
                unknown: "Unbekannt",
                app_already_installed: "App ist bereits auf Ihrem Gerät installiert!",
                install_unavailable: "Installation nicht verfügbar. Versuchen Sie, die Website im Browser zu öffnen."
            },
            ja: {
                subtitle: "100% 匿名デート",
                premium_profiles: "プレミアムプロフィール",
                online_now: "オンライン中",
                anonymous_dating: "匿名デート",
                filters: "フィルター",
                city: "都市",
                all_cities: "すべての都市",
                nationality: "国籍",
                all_nationalities: "すべての国籍",
                gender: "性別",
                all_genders: "すべて",
                travel_city: "旅行先の都市",
                age: "年齢",
                height: "身長 (cm)",
                weight: "体重 (kg)",
                chest: "バスト",
                reset: "リセット",
                apply: "適用",
                loading: "読み込み中...",
                loading_more: "さらに読み込み中...",
                view_profile: "もっと見る",
                write_message: "メッセージ",
                book_with_crypto: "支払い",
                promocode: "プロモコード",
                years: "歳",
                cm: "cm",
                kg: "kg",
                chest_size: "バスト",
                apply_promocode: "適用",
                close: "閉じる",
                error_sending: "メッセージ送信エラー",
                enter_promocode: "割引のためプロモコードを入力",
                comments: "コメント",
                post_comment: "コメントを投稿",
                no_comments: "まだコメントはありません",
                your_comment: "あなたのコメント...",
                pay_now: "支払いを確認",
                amount: "金額:",
                select_crypto: "暗号通貨を選択:",
                wallet_address: "ウォレットアドレス:",
                booking_profile: "プロフィール予約:",
                payment_awaiting: "支払い処理中",
                payment_processing: "お支払いを処理しています。お待ちください...",
                timer_label: "残り時間",
                chat_with: "チャット",
                attach_file: "📎",
                comment_permission_required: "支払いが必要",
                complete_transaction_to_comment: "コメントを残すには支払いを完了してください",
                type_message: "メッセージを入力...",
                chat_warning: "他のメッセンジャーの連絡先を共有しないでください。これはモデルの安全のためです。",
                female: "女性",
                male: "男性",
                transgender: "トランスジェンダー",
                description: "説明",
                vip_catalog: "VIPカタログ",
                extra_vip: "エクストラVIP",
                secret_catalog: "シークレットカタログ",
                label_gender: "性別:",
                label_city: "都市:",
                label_nationality: "国籍:",
                label_travel_cities: "旅行先:",
                label_description: "説明:",
                nav_home: "ホーム",
                nav_chats: "チャット",
                nav_my_bookings: "予約一覧",
                nav_pending: "保留中",
                page_my_chats: "マイチャット",
                page_my_bookings: "予約一覧",
                page_pending_orders: "保留中の注文",
                loading_premium: "プレミアム体験を読み込み中...",
                loading_chats: "チャットを読み込み中...",
                loading_orders: "注文を読み込み中...",
                no_chats: "チャットはまだありません",
                no_orders: "注文なし",
                no_booked_orders: "確認済みの予約なし",
                no_unpaid_orders: "保留中の注文なし",
                order_pending: "保留中",
                order_confirmed: "確認済み",
                order_expired: "期限切れ",
                booking_confirmed: "予約確認済み",
                booking_expired: "予約期限切れ",
                error_loading_profile: "プロフィール読み込みエラー",
                error_loading_chats: "チャット読み込みエラー",
                error_loading_orders: "注文読み込みエラー",
                error_payment: "支払いエラー",
                error_adding_comment: "コメント追加エラー",
                alert_enter_comment: "コメントを入力してください",
                alert_payment_expired: "支払い時間が切れました",
                alert_select_crypto: "暗号通貨を選択してください",
                alert_min_amount: "有効な金額を入力してください（最低$10）",
                alert_profile_not_found: "プロフィールが見つかりません",
                order_number: "注文",
                order_amount: "金額",
                order_date: "日付",
                order_crypto: "暗号通貨",
                add_to_homescreen: "ホーム画面に追加",
                anonymous_user: "匿名ユーザー",
                add_to_screen: "📱 画面に追加",
                ios_add_title: "ホーム画面に追加",
                ios_step1: "共有ボタンをタップ",
                ios_step2: "「ホーム画面に追加」を選択",
                ios_step3: "「追加」をタップ",
                ios_got_it: "了解",
                no_profiles: "プロフィールが見つかりません",
                promocode_invalid: "無効なプロモコード",
                download: "ダウンロード",
                copied: "クリップボードにコピーしました",
                unlock_access: "アクセスのロック解除",
                profiles_count: "プロフィール",
                payment_name: "名前:",
                payment_age: "年齢:",
                payment_gender: "性別:",
                payment_city: "都市:",
                unknown: "不明",
                app_already_installed: "アプリはすでにデバイスにインストールされています！",
                install_unavailable: "インストールできません。ブラウザでサイトを開いてみてください。"
            },
            ko: {
                subtitle: "100% 익명 데이트",
                premium_profiles: "프리미엄 프로필",
                online_now: "온라인 중",
                anonymous_dating: "익명 데이트",
                filters: "필터",
                city: "도시",
                all_cities: "모든 도시",
                nationality: "국적",
                all_nationalities: "모든 국적",
                gender: "성별",
                all_genders: "모두",
                travel_city: "여행 도시",
                age: "나이",
                height: "키 (cm)",
                weight: "몸무게 (kg)",
                chest: "가슴",
                reset: "초기화",
                apply: "적용",
                loading: "로딩 중...",
                loading_more: "더 로딩 중...",
                view_profile: "더보기",
                write_message: "메시지",
                book_with_crypto: "결제",
                promocode: "프로모션 코드",
                years: "세",
                cm: "cm",
                kg: "kg",
                chest_size: "가슴",
                apply_promocode: "적용",
                close: "닫기",
                error_sending: "메시지 전송 오류",
                enter_promocode: "할인을 받으려면 프로모션 코드 입력",
                comments: "댓글",
                post_comment: "댓글 게시",
                no_comments: "아직 댓글이 없습니다",
                your_comment: "댓글을 입력하세요...",
                pay_now: "결제 확인",
                amount: "금액:",
                select_crypto: "암호화폐 선택:",
                wallet_address: "지갑 주소:",
                booking_profile: "프로필 예약:",
                payment_awaiting: "결제 처리 중",
                payment_processing: "결제가 처리 중입니다. 기다려 주세요...",
                timer_label: "남은 시간",
                chat_with: "채팅",
                attach_file: "📎",
                comment_permission_required: "결제 필요",
                complete_transaction_to_comment: "댓글을 남기려면 결제를 완료하세요",
                type_message: "메시지 입력...",
                chat_warning: "다른 메신저의 연락처를 공유하지 마세요. 이것은 모델의 안전을 위한 것입니다.",
                female: "여성",
                male: "남성",
                transgender: "트랜스젠더",
                description: "설명",
                vip_catalog: "VIP 카탈로그",
                extra_vip: "엑스트라 VIP",
                secret_catalog: "시크릿 카탈로그",
                label_gender: "성별:",
                label_city: "도시:",
                label_nationality: "국적:",
                label_travel_cities: "여행 도시:",
                label_description: "설명:",
                nav_home: "홈",
                nav_chats: "채팅",
                nav_my_bookings: "내 예약",
                nav_pending: "대기 중",
                page_my_chats: "내 채팅",
                page_my_bookings: "내 예약",
                page_pending_orders: "대기 중인 주문",
                loading_premium: "프리미엄 경험 로딩 중...",
                loading_chats: "채팅 로딩 중...",
                loading_orders: "주문 로딩 중...",
                no_chats: "아직 채팅이 없습니다",
                no_orders: "주문 없음",
                no_booked_orders: "확인된 예약 없음",
                no_unpaid_orders: "대기 중인 주문 없음",
                order_pending: "대기 중",
                order_confirmed: "확인됨",
                order_expired: "만료됨",
                booking_confirmed: "예약 확인됨",
                booking_expired: "예약 만료됨",
                error_loading_profile: "프로필 로딩 오류",
                error_loading_chats: "채팅 로딩 오류",
                error_loading_orders: "주문 로딩 오류",
                error_payment: "결제 오류",
                error_adding_comment: "댓글 추가 오류",
                alert_enter_comment: "댓글 텍스트를 입력하세요",
                alert_payment_expired: "결제 시간이 만료되었습니다",
                alert_select_crypto: "암호화폐를 선택하세요",
                alert_min_amount: "유효한 금액을 입력하세요 (최소 $10)",
                alert_profile_not_found: "프로필을 찾을 수 없습니다",
                order_number: "주문",
                order_amount: "금액",
                order_date: "날짜",
                order_crypto: "암호화폐",
                add_to_homescreen: "홈 화면에 추가",
                anonymous_user: "익명 사용자",
                add_to_screen: "📱 화면에 추가",
                ios_add_title: "홈 화면에 추가",
                ios_step1: "공유 버튼을 탭하세요",
                ios_step2: "\"홈 화면에 추가\" 선택",
                ios_step3: "\"추가\" 탭",
                ios_got_it: "알겠습니다",
                no_profiles: "프로필을 찾을 수 없습니다",
                promocode_invalid: "유효하지 않은 프로모 코드",
                download: "다운로드",
                copied: "클립보드에 복사됨",
                unlock_access: "액세스 잠금 해제",
                profiles_count: "프로필",
                payment_name: "이름:",
                payment_age: "나이:",
                payment_gender: "성별:",
                payment_city: "도시:",
                unknown: "알 수 없음",
                app_already_installed: "앱이 이미 기기에 설치되어 있습니다!",
                install_unavailable: "설치할 수 없습니다. 브라우저에서 사이트를 열어보세요."
            },
            zh: {
                subtitle: "100% 匿名约会",
                premium_profiles: "高级档案",
                online_now: "在线",
                anonymous_dating: "匿名约会",
                filters: "过滤器",
                city: "城市",
                all_cities: "所有城市",
                nationality: "国籍",
                all_nationalities: "所有国籍",
                gender: "性别",
                all_genders: "全部",
                travel_city: "旅行城市",
                age: "年龄",
                height: "身高 (厘米)",
                weight: "体重 (公斤)",
                chest: "胸围",
                reset: "重置",
                apply: "应用",
                loading: "加载中...",
                loading_more: "加载更多...",
                view_profile: "更多",
                write_message: "写信",
                book_with_crypto: "支付",
                promocode: "促销代码",
                years: "岁",
                cm: "厘米",
                kg: "公斤",
                chest_size: "胸围",
                apply_promocode: "应用",
                close: "关闭",
                error_sending: "发送消息时出错",
                enter_promocode: "输入促销代码获得折扣",
                comments: "评论",
                post_comment: "发表评论",
                no_comments: "还没有评论",
                your_comment: "你的评论...",
                pay_now: "确认付款",
                amount: "金额:",
                select_crypto: "选择加密货币:",
                wallet_address: "钱包地址:",
                booking_profile: "预订档案:",
                payment_awaiting: "处理付款",
                payment_processing: "您的付款正在处理中。请稍候...",
                timer_label: "剩余时间",
                chat_with: "聊天",
                attach_file: "📎",
                comment_permission_required: "需要付款",
                complete_transaction_to_comment: "完成付款以留下评论",
                type_message: "输入消息...",
                chat_warning: "请勿分享其他通讯软件的联系方式。这是为了模特的安全。",
                female: "女性",
                male: "男性",
                transgender: "跨性别",
                description: "描述",
                vip_catalog: "VIP目录",
                extra_vip: "特级VIP",
                secret_catalog: "秘密目录",
                label_gender: "性别:",
                label_city: "城市:",
                label_nationality: "国籍:",
                label_travel_cities: "旅行城市:",
                label_description: "描述:",
                nav_home: "首页",
                nav_chats: "聊天",
                nav_my_bookings: "我的预订",
                nav_pending: "待处理",
                page_my_chats: "我的聊天",
                page_my_bookings: "我的预订",
                page_pending_orders: "待处理订单",
                loading_premium: "正在加载高级体验...",
                loading_chats: "正在加载聊天...",
                loading_orders: "正在加载订单...",
                no_chats: "暂无聊天",
                no_orders: "暂无订单",
                no_booked_orders: "暂无已确认预订",
                no_unpaid_orders: "暂无待处理订单",
                order_pending: "待处理",
                order_confirmed: "已确认",
                order_expired: "已过期",
                booking_confirmed: "预订已确认",
                booking_expired: "预订已过期",
                error_loading_profile: "加载档案出错",
                error_loading_chats: "加载聊天出错",
                error_loading_orders: "加载订单出错",
                error_payment: "支付错误",
                error_adding_comment: "添加评论出错",
                alert_enter_comment: "请输入评论内容",
                alert_payment_expired: "支付时间已过期",
                alert_select_crypto: "请选择加密货币",
                alert_min_amount: "请输入有效金额（最低$10）",
                alert_profile_not_found: "找不到档案",
                order_number: "订单",
                order_amount: "金额",
                order_date: "日期",
                order_crypto: "加密货币",
                add_to_homescreen: "添加到主屏幕",
                anonymous_user: "匿名用户",
                add_to_screen: "📱 添加到屏幕",
                ios_add_title: "添加到主屏幕",
                ios_step1: "点击分享按钮",
                ios_step2: "选择\"添加到主屏幕\"",
                ios_step3: "点击\"添加\"",
                ios_got_it: "明白了",
                no_profiles: "未找到资料",
                promocode_invalid: "无效的促销代码",
                download: "下载",
                copied: "已复制到剪贴板",
                unlock_access: "解锁访问",
                profiles_count: "资料",
                payment_name: "姓名:",
                payment_age: "年龄:",
                payment_gender: "性别:",
                payment_city: "城市:",
                unknown: "未知",
                app_already_installed: "应用已安装在您的设备上！",
                install_unavailable: "无法安装。请尝试在浏览器中打开网站。"
            }
        };

        let translations = allTranslations[currentLanguage];

        // Элементы DOM
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const vipCatalogsSection = document.getElementById('vip-catalogs');
        const vipCatalogsGrid = document.getElementById('vip-catalogs-grid');
        const cardsContainer = document.getElementById('cards-container');
        const loadingMore = document.getElementById('loading-more');
        const profileModal = document.getElementById('profile-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalProfileName = document.getElementById('modal-profile-name');
        const modalProfileAge = document.getElementById('modal-profile-age');
        const modalProfileHeight = document.getElementById('modal-profile-height');
        const modalProfileWeight = document.getElementById('modal-profile-weight');
        const modalProfileChest = document.getElementById('modal-profile-chest');
        const modalProfileGender = document.getElementById('modal-profile-gender');
        const modalProfileCity = document.getElementById('modal-profile-city');
        const modalProfileNationality = document.getElementById('modal-profile-nationality');
        const modalProfileTravelCities = document.getElementById('modal-profile-travel-cities');
        const modalProfileDescription = document.getElementById('modal-profile-description');
        const writeBtn = document.getElementById('write-btn');
        const payBtn = document.getElementById('pay-btn');
        const promoBtn = document.getElementById('promo-btn');
        const chatModal = document.getElementById('chat-modal');
        const closeChatBtn = document.getElementById('close-chat');
        const chatBody = document.getElementById('chat-body');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send');
        const chatTitle = document.getElementById('chat-title-text');
        const chatAvatar = document.getElementById('chat-avatar');
        const fileInput = document.getElementById('file-input');
        const fileBtn = document.getElementById('file-btn');
        const promoModal = document.getElementById('promo-modal');
        const promoInput = document.getElementById('promo-input');
        const applyPromoBtn = document.getElementById('apply-promo');
        const promoResult = document.getElementById('promo-result');
        const closePromoBtn = document.getElementById('close-promo');
        const closePromoBtn2 = document.getElementById('close-promo-btn');
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentBtn = document.getElementById('close-payment');
        const paymentAmount = document.getElementById('payment-amount');
        const walletAddress = document.getElementById('wallet-address');
        const addressText = document.getElementById('address-text');
        const copyAddressBtn = document.getElementById('copy-address');
        const confirmPaymentBtn = document.getElementById('confirm-payment');
        const paymentSuccess = document.getElementById('payment-success');
        const closeSuccessBtn = document.getElementById('close-success');
        const cryptoOptions = document.querySelectorAll('.crypto-option');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const postCommentBtn = document.getElementById('post-comment-btn');
        const commentsList = document.getElementById('comments-list');
        const noComments = document.getElementById('no-comments');
        const commentPermissionRequired = document.getElementById('comment-permission-required');
        const commentPermissionText = document.getElementById('comment-permission-text');

        // Элементы слайдера
        const sliderMain = document.getElementById('slider-main');
        const sliderThumbs = document.getElementById('slider-thumbs');
        const prevSlideBtn = document.getElementById('prev-slide');
        const nextSlideBtn = document.getElementById('next-slide');

        // Элементы фильтров
        const filtersToggle = document.getElementById('filters-toggle');
        const filtersSidebar = document.getElementById('filters-sidebar');
        const filtersOverlay = document.getElementById('filters-overlay');
        const closeFiltersBtn = document.getElementById('close-filters');
        const filterCity = document.getElementById('filter-city');
        const filterNationality = document.getElementById('filter-nationality');
        const filterGender = document.getElementById('filter-gender');
        const filterTravelCity = document.getElementById('filter-travel-city');
        const filterAgeMin = document.getElementById('filter-age-min');
        const filterAgeMax = document.getElementById('filter-age-max');
        const filterHeightMin = document.getElementById('filter-height-min');
        const filterHeightMax = document.getElementById('filter-height-max');
        const filterWeightMin = document.getElementById('filter-weight-min');
        const filterWeightMax = document.getElementById('filter-weight-max');
        const filterChestMin = document.getElementById('filter-chest-min');
        const filterChestMax = document.getElementById('filter-chest-max');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const activeFilters = document.getElementById('active-filters');

        // Language Selector
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageText = document.getElementById('language-text');

        // Баннер под статистикой
        const statsBanner = document.getElementById('stats-banner');
        const statsBannerText = document.getElementById('stats-banner-text');
        const statsBannerLink = document.getElementById('stats-banner-link');
        const closeStatsBanner = document.getElementById('close-stats-banner');

        // Элементы оплаты
        const paymentProfileName = document.getElementById('payment-profile-name');
        const paymentProfileAge = document.getElementById('payment-profile-age');
        const paymentProfileGender = document.getElementById('payment-profile-gender');
        const paymentProfileCity = document.getElementById('payment-profile-city');

        // Инициализация
        document.addEventListener('DOMContentLoaded', async function() {
            // Загружаем незавершенные платежи если есть
            loadPendingPayments();

            // Сразу скрываем экран загрузки и показываем контент
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';

                    // Загружаем сохраненный язык или английский по умолчанию
                    const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
                    loadTranslations(savedLanguage);

                    loadVipCatalogs();
                    loadMoreProfiles();
                    setupEventListeners();
                    initFilters();
                    updateStats();
                    loadStatsBanner();
                    startOnlineCountUpdates();
                }, 500);
            }, 2000);

            if (typeof window.Telegram !== 'undefined') {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }

            // Аутентификация через Telegram WebApp
            if (tg && tg.initData) {
                await authenticateWithTelegram();
            }
        });

        // Загрузка VIP каталогов (хардкоженные данные)
        async function loadVipCatalogs() {
            // Хардкоженные VIP каталоги
            vipCatalogs = {
                vip: {
                    name: "VIP Catalog",
                    price: 199,
                    redirect_url: "https://t.me/vip_channel",
                    visible: true,
                    preview_count: 250,
                    preview_profiles: [
                        {name: "Diana", age: 16, city: "Moscow"},
                        {name: "Mary", age: 18, city: "Guangzhou"},
                        {name: "Lexy", age: 17, city: "London"}
                    ]
                },
                extra_vip: {
                    name: "Extra VIP",
                    price: 699,
                    redirect_url: "https://t.me/extra_vip_channel",
                    visible: true,
                    preview_count: 300,
                    preview_profiles: [
                        {name: "Julia", age: 22, city: "Tokyo"},
                        {name: "Yu Chen", age: 16, city: "Shanghai"},
                        {name: "Ying", age: 19, city: "Beijing"}
                    ]
                },
                secret: {
                    name: "Secret Catalog",
                    price: 2499,
                    redirect_url: "https://t.me/secret_channel",
                    visible: true,
                    preview_count: 500,
                    preview_profiles: [
                        {name: "Sandy", age: 16, city: "Miami"},
                        {name: "Lana", age: 21, city: "Dubai"},
                        {name: "Benny", age: 20, city: "Seoul"}
                    ]
                }
            };
            renderVipCatalogs();
        }

        // Отрисовка VIP каталогов
        function renderVipCatalogs() {
            vipCatalogsGrid.innerHTML = '';

            Object.entries(vipCatalogs).forEach(([catalogKey, catalog]) => {
                if (!catalog.visible) return;

                const catalogDiv = document.createElement('div');
                catalogDiv.className = 'vip-catalog-card';
                const previewProfiles = catalog.preview_profiles || [];
                catalogDiv.innerHTML = `
                    <div class="vip-catalog-header">
                        <span class="vip-catalog-name">${catalog.name}</span>
                        <span class="vip-catalog-price">$${catalog.price}</span>
                    </div>
                    <div class="vip-profiles-grid" id="vip-profiles-${catalogKey}">
                        <!-- Анкеты будут добавлены через JS -->
                    </div>
                    <div class="vip-catalog-stats">
                        <span>${catalog.preview_count} ${translations.premium_profiles_count || 'premium profiles'}</span>
                        <span>${translations.blurred_preview || 'Blurred Preview'}</span>
                    </div>
                    <a href="${catalog.redirect_url}" target="_blank" class="unlock-btn">
                        ${translations.unlock_access || 'Unlock Access'} - $${catalog.price}
                    </a>
                `;
                vipCatalogsGrid.appendChild(catalogDiv);

                // Добавляем preview анкеты в этот каталог
                renderVipProfilesForCatalog(catalogKey, previewProfiles);
            });
        }

        // Загрузка VIP анкет
        async function loadVipProfiles() {
            try {
                const response = await fetch('/api/vip-profiles');
                const data = await response.json();
                return data.profiles;
            } catch (error) {
                console.error('Error loading VIP profiles:', error);
                return [];
            }
        }

        // Отрисовка VIP анкет для каталога
        function renderVipProfilesForCatalog(catalogKey, previewProfiles) {
            const profilesContainer = document.getElementById(`vip-profiles-${catalogKey}`);
            if (!profilesContainer) return;

            profilesContainer.innerHTML = '';

            // Капитализация имени
            function capitalize(str) {
                if (!str) return '';
                return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
            }

            // Функция для генерации случайного градиента
            function getRandomGradient() {
                const gradients = [
                    'linear-gradient(135deg, rgba(255,107,157,0.4), rgba(102,126,234,0.4))',
                    'linear-gradient(135deg, rgba(102,126,234,0.4), rgba(118,75,162,0.4))',
                    'linear-gradient(135deg, rgba(255,107,157,0.4), rgba(118,75,162,0.4))',
                    'linear-gradient(135deg, rgba(118,75,162,0.4), rgba(255,107,157,0.4))',
                    'linear-gradient(45deg, rgba(255,107,157,0.3), rgba(102,126,234,0.5))',
                    'linear-gradient(225deg, rgba(102,126,234,0.4), rgba(255,107,157,0.3))',
                    'radial-gradient(circle, rgba(255,107,157,0.4), rgba(102,126,234,0.3))',
                    'radial-gradient(circle, rgba(118,75,162,0.4), rgba(255,107,157,0.3))'
                ];
                return gradients[Math.floor(Math.random() * gradients.length)];
            }

            // Функция для создания профиля
            function createProfileHtml(profile) {
                const randomGradient = getRandomGradient();
                // SECURITY FIX: Escape user-generated content to prevent XSS
                return `
                    <div class="vip-profile-preview">
                        <div class="vip-profile-image" style="background: ${randomGradient}; background-size: cover; background-position: center;"></div>
                        <div class="vip-profile-overlay">
                            <div class="vip-profile-info">
                                <div class="vip-profile-name">${escapeHtml(capitalize(profile.name))}</div>
                                <div class="vip-profile-age">${escapeHtml(profile.age)} ${escapeHtml(translations.years_short || 'y.o')}</div>
                                <div class="vip-profile-city">${escapeHtml(capitalize(profile.city))}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            previewProfiles.forEach((profile, index) => {
                if (!profile.name) return;

                // Все профили в одном ряду
                const profileDiv = document.createElement('div');
                profileDiv.innerHTML = createProfileHtml(profile);
                profilesContainer.appendChild(profileDiv);
            });
        }

        // Обновление онлайн-статистики каждые 3 минуты
        function startOnlineCountUpdates() {
            updateOnlineCount(); // Первоначальное обновление
            onlineUpdateInterval = setInterval(updateOnlineCount, 180000); // 3 минуты
        }

        function updateOnlineCount() {
            const profilesCount = currentProfiles.length;
            onlineCount = Math.min(Math.floor(Math.random() * profilesCount) + 1, profilesCount);
            document.getElementById('online-count').textContent = onlineCount;
        }

        // Загрузка баннера под статистикой
        async function loadStatsBanner() {
            try {
                const response = await fetch('/api/settings/banner');
                const bannerData = await response.json();

                if (bannerData.visible && bannerData.text) {
                    statsBanner.style.display = 'block';
                    statsBannerText.textContent = bannerData.text;
                    statsBannerLink.textContent = bannerData.link_text || 'Join Channel';
                    statsBannerLink.href = bannerData.link || '#';
                }
            } catch (error) {
                console.error('Error loading banner:', error);
            }
        }

        // Загрузка переводов
        function loadTranslations(lang) {
            if (allTranslations[lang]) {
                translations = allTranslations[lang];
                currentLanguage = lang;
                languageText.textContent = getLanguageCode(lang);
                // Сохраняем выбор языка в localStorage
                localStorage.setItem('selectedLanguage', lang);
                applyTranslations();
            }
        }

        // Получить код языка для кнопки
        function getLanguageCode(lang) {
            const codes = {
                'en': 'EN',
                'ja': 'JA',
                'ko': 'KO',
                'zh': 'ZH',
                'ar': 'AR',
                'de': 'DE',
                'es': 'ES'
            };
            return codes[lang] || 'EN';
        }

        // Безопасное применение перевода
        function safeSetText(id, text, isPlaceholder = false) {
            const element = document.getElementById(id);
            if (element && text !== undefined) {
                if (isPlaceholder) {
                    element.placeholder = text;
                } else {
                    element.textContent = text;
                }
            }
        }

        // Применение переводов
        function applyTranslations() {
            // Обновляем все тексты
            safeSetText('app-subtitle', translations.subtitle);
            safeSetText('premium-profiles-label', translations.premium_profiles);
            safeSetText('online-now-label', translations.online_now);
            safeSetText('anonymous-dating-label', translations.anonymous_dating);
            safeSetText('filters-title', translations.filters);
            safeSetText('filter-city-label', translations.city);
            safeSetText('all-cities', translations.all_cities);
            safeSetText('filter-nationality-label', translations.nationality);
            safeSetText('all-nationalities', translations.all_nationalities);
            safeSetText('filter-gender-label', translations.gender);
            safeSetText('all-genders', translations.all_genders);
            safeSetText('filter-travel-city-label', translations.travel_city);
            safeSetText('all-travel-cities', translations.all_cities);
            safeSetText('filter-age-label', translations.age);
            safeSetText('filter-height-label', translations.height);
            safeSetText('filter-weight-label', translations.weight);
            safeSetText('filter-chest-label', translations.chest);
            safeSetText('reset-text', translations.reset);
            safeSetText('apply-text', translations.apply);
            safeSetText('main-loading', translations.loading);
            safeSetText('loading-more-text', translations.loading_more);
            safeSetText('write-text', translations.write_message);
            safeSetText('pay-text', translations.book_with_crypto);
            safeSetText('promo-text', translations.promocode);
            safeSetText('years-text', translations.years);
            safeSetText('cm-text', translations.cm);
            safeSetText('kg-text', translations.kg);
            safeSetText('apply-promo-text', translations.apply_promocode);
            safeSetText('close-promo-text', translations.close);
            safeSetText('promo-description', translations.enter_promocode);
            safeSetText('comments-title', translations.comments);
            safeSetText('post-comment-text', translations.post_comment);
            safeSetText('no-comments', translations.no_comments);
            safeSetText('comment-input', translations.your_comment, true);
            safeSetText('confirm-payment-text', translations.pay_now);
            safeSetText('payment-amount-label', translations.amount);
            safeSetText('payment-description', translations.select_crypto);
            safeSetText('wallet-address-label', translations.wallet_address);
            safeSetText('payment-profile-title', translations.booking_profile);
            safeSetText('payment-success-title', translations.payment_awaiting);
            safeSetText('payment-success-message', translations.payment_processing);
            safeSetText('close-success-text', translations.close);

            const timerLabel = document.getElementById('timer-label');
            if (timerLabel && translations.timer_label) {
                timerLabel.textContent = translations.timer_label + ':';
            }

            safeSetText('chat-title-text', translations.chat_with);
            safeSetText('attach-file-text', translations.attach_file);
            safeSetText('chat-warning', translations.chat_warning);
            safeSetText('comment-permission-text', translations.comment_permission_required);
            safeSetText('complete-transaction-text', translations.complete_transaction_to_comment);

            // Обновляем опции гендера
            const genderOptions = document.querySelectorAll('#filter-gender option');
            genderOptions[1].textContent = translations.female;
            genderOptions[2].textContent = translations.male;
            genderOptions[3].textContent = translations.transgender;

            // Обновляем лейблы в модальном окне профиля
            safeSetText('label-gender', translations.label_gender);
            safeSetText('label-city', translations.label_city);
            safeSetText('label-nationality', translations.label_nationality);
            safeSetText('label-travel-cities', translations.label_travel_cities);
            safeSetText('label-description', translations.label_description);

            if (chatInput && translations.type_message) {
                chatInput.placeholder = translations.type_message;
            }

            // Обновляем навигацию (текст без badges)
            const navHomeLabel = document.getElementById('nav-home-label');
            const navChatsLabel = document.getElementById('nav-chats-label');
            const navPaidLabel = document.getElementById('nav-paid-label');
            const navUnpaidLabel = document.getElementById('nav-unpaid-label');

            if (navHomeLabel && translations.nav_home) {
                navHomeLabel.childNodes[0].textContent = translations.nav_home;
            }
            if (navChatsLabel && translations.nav_chats) {
                // Сохраняем badge если есть
                const badge = navChatsLabel.querySelector('.nav-badge');
                navChatsLabel.childNodes[0].textContent = translations.nav_chats;
            }
            if (navPaidLabel && translations.nav_my_bookings) {
                navPaidLabel.childNodes[0].textContent = translations.nav_my_bookings;
            }
            if (navUnpaidLabel && translations.nav_pending) {
                navUnpaidLabel.childNodes[0].textContent = translations.nav_pending;
            }

            // Обновляем заголовки страниц
            const chatsPageTitle = document.querySelector('#chats-page .main-header h2');
            const paidPageTitle = document.querySelector('#paid-orders-page .main-header h2');
            const unpaidPageTitle = document.querySelector('#unpaid-orders-page .main-header h2');

            if (chatsPageTitle && translations.page_my_chats) {
                chatsPageTitle.textContent = translations.page_my_chats;
            }
            if (paidPageTitle && translations.page_my_bookings) {
                paidPageTitle.textContent = translations.page_my_bookings;
            }
            if (unpaidPageTitle && translations.page_pending_orders) {
                unpaidPageTitle.textContent = translations.page_pending_orders;
            }

            // Обновляем текст загрузки
            const loadingScreenText = document.querySelector('#loading-screen p');
            if (loadingScreenText && translations.loading_premium) {
                loadingScreenText.textContent = translations.loading_premium;
            }

            // Обновляем текст кнопки установки приложения
            safeSetText('add-to-screen-text', translations.add_to_screen);

            updateActiveFilters();
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Language Selector
            languageBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                languageDropdown.classList.toggle('active');
            });

            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    switchLanguage(lang);
                    languageDropdown.classList.remove('active');
                });
            });

            // Закрытие language dropdown при клике вне
            document.addEventListener('click', function(event) {
                if (!languageBtn.contains(event.target)) {
                    languageDropdown.classList.remove('active');
                }
            });

            // Фильтры
            filtersToggle.addEventListener('click', openFilters);
            closeFiltersBtn.addEventListener('click', closeFilters);
            filtersOverlay.addEventListener('click', closeFilters);
            resetFiltersBtn.addEventListener('click', resetFilters);
            applyFiltersBtn.addEventListener('click', applyFilters);

            // Слайдер фото
            prevSlideBtn.addEventListener('click', prevSlide);
            nextSlideBtn.addEventListener('click', nextSlide);

            // Свайп для слайдера
            let startX = 0;
            let endX = 0;

            sliderMain.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });

            sliderMain.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                handleSwipe();
            });

            function handleSwipe() {
                const swipeDistance = startX - endX;
                if (Math.abs(swipeDistance) > 50) { // Минимальное расстояние свайпа
                    if (swipeDistance > 0) {
                        nextSlide();
                    } else {
                        prevSlide();
                    }
                }
            }

            // Комментарии
            postCommentBtn.addEventListener('click', addComment);

            // Обработка выбора файла
            fileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            // Модальные окна
            closeModalBtn.addEventListener('click', closeProfileModal);
            closeChatBtn.addEventListener('click', closeChatModal);
            writeBtn.addEventListener('click', openChat);
            payBtn.addEventListener('click', openPaymentModal);
            promoBtn.addEventListener('click', openPromoModal);
            closePromoBtn.addEventListener('click', closePromoModal);
            closePromoBtn2.addEventListener('click', closePromoModal);

            // Оплата
            closePaymentBtn.addEventListener('click', closePaymentModal);
            cryptoOptions.forEach(option => {
                option.addEventListener('click', function() {
                    cryptoOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    showWalletAddress(this.getAttribute('data-crypto'));
                });
            });
            copyAddressBtn.addEventListener('click', copyWalletAddress);
            confirmPaymentBtn.addEventListener('click', processPayment);
            closeSuccessBtn.addEventListener('click', closePaymentModal);

            // Промокод
            applyPromoBtn.addEventListener('click', applyPromoCode);
            promoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') applyPromoCode();
            });

            // Чат
            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Авто-высота textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            window.addEventListener('scroll', handleScroll);
        }

        // Обновление статистики
        function updateStats() {
            const profilesCount = currentProfiles.length;
            document.getElementById('profiles-count').textContent = profilesCount;
        }

        // Слайдер фото
        function updateSlider() {
            if (!currentProfile || !currentProfile.photos) return;

            sliderMain.innerHTML = '';
            sliderThumbs.innerHTML = '';

            currentProfile.photos.forEach((photo, index) => {
                // Основное фото
                const slide = document.createElement('img');
                slide.src = photo;
                slide.alt = `${currentProfile.name} photo ${index + 1}`;
                slide.className = 'slider-image';
                if (index === currentSlideIndex) {
                    slide.classList.add('active');
                }
                sliderMain.appendChild(slide);

                // Миниатюра
                const thumb = document.createElement('div');
                thumb.className = `slider-thumb ${index === currentSlideIndex ? 'active' : ''}`;
                thumb.innerHTML = `<img src="${photo}" alt="Thumbnail ${index + 1}">`;
                thumb.addEventListener('click', () => {
                    currentSlideIndex = index;
                    updateSlider();
                });
                sliderThumbs.appendChild(thumb);
            });
        }

        function nextSlide() {
            if (!currentProfile || !currentProfile.photos) return;
            currentSlideIndex = (currentSlideIndex + 1) % currentProfile.photos.length;
            updateSlider();
        }

        function prevSlide() {
            if (!currentProfile || !currentProfile.photos) return;
            currentSlideIndex = (currentSlideIndex - 1 + currentProfile.photos.length) % currentProfile.photos.length;
            updateSlider();
        }

        // Комментарии
        async function loadComments() {
            if (!currentProfile) return;

            try {
                const response = await fetch(`/api/profiles/${currentProfile.id}/comments`);
                const data = await response.json();

                commentsList.innerHTML = '';

                if (data.comments.length === 0) {
                    noComments.style.display = 'block';
                } else {
                    noComments.style.display = 'none';
                    data.comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment';
                        // SECURITY FIX: Escape user-generated content to prevent XSS
                        commentDiv.innerHTML = `
                            <div class="comment-header">
                                <span class="comment-author">${escapeHtml(comment.user_name)}</span>
                                <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.text)}</div>
                        `;
                        commentsList.appendChild(commentDiv);
                    });
                }

                // Проверяем, может ли пользователь оставлять комментарии
                checkCommentPermission();
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        // Проверка разрешения на комментарии
        async function checkCommentPermission() {
            if (!currentProfile) return;

            try {
                const response = await fetch(addTelegramUserParam(`/api/chats/${currentProfile.id}/messages`));
                const data = await response.json();

                // Пользователь может комментировать, если есть системное сообщение о завершенной транзакции
                const hasSuccessfulTransaction = data.messages.some(msg =>
                    msg.is_system && msg.text && msg.text.toLowerCase().includes('transaction successful')
                );

                canComment = hasSuccessfulTransaction;

                // Если транзакция завершена, очищаем незавершенный платеж
                if (hasSuccessfulTransaction && pendingPayment) {
                    clearPendingPayment();
                }

                // Показываем или скрываем форму комментариев
                commentForm.style.display = canComment ? 'block' : 'none';
                commentPermissionRequired.style.display = canComment ? 'none' : 'block';
            } catch (error) {
                console.error('Error checking comment permission:', error);
                commentForm.style.display = 'none';
                commentPermissionRequired.style.display = 'block';
            }
        }

        async function addComment() {
            if (!currentProfile || !canComment) return;

            const text = commentInput.value.trim();

            if (!text) {
                alert(translations.alert_enter_comment || 'Please enter comment text');
                return;
            }

            try {
                const response = await fetch(`/api/profiles/${currentProfile.id}/comments`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_name: 'Anonymous User', // Всегда анонимный
                        text: text
                    })
                });

                if (response.ok) {
                    commentInput.value = '';
                    loadComments();
                } else {
                    const errorData = await response.json();
                    alert(errorData.detail || translations.error_adding_comment || 'Error adding comment');
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert(translations.error_adding_comment || 'Error adding comment');
            }
        }

        // Обработка выбора файла
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                sendMessage(file);
            }
        }

        // Переключение языка
        function switchLanguage(lang) {
            loadTranslations(lang);

            currentPage = 0;
            currentProfiles = [];
            cardsContainer.innerHTML = `<div class="loading">${translations.loading}</div>`;
            loadMoreProfiles();
            loadVipCatalogs();
        }

        // Открытие фильтров
        function openFilters() {
            filtersSidebar.classList.add('active');
            filtersOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Закрытие фильтров
        function closeFilters() {
            filtersSidebar.classList.remove('active');
            filtersOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Сброс фильтров
        function resetFilters() {
            currentFilters = {
                city: 'all',
                nationality: 'all',
                travel_city: 'all',
                gender: 'all',
                age_min: 18,
                age_max: 70,
                height_min: 120,
                height_max: 220,
                weight_min: 35,
                weight_max: 120,
                chest_min: 1,
                chest_max: 12
            };
            updateFilterInputs();
            updateActiveFilters();
            
            // Показываем VIP каталоги при сбросе фильтров
            vipCatalogsSection.style.display = 'block';
            
            applyFilters();
        }

        // Обновление значений в полях фильтров
        function updateFilterInputs() {
            filterCity.value = currentFilters.city;
            filterNationality.value = currentFilters.nationality;
            filterGender.value = currentFilters.gender;
            filterTravelCity.value = currentFilters.travel_city;
            filterAgeMin.value = currentFilters.age_min;
            filterAgeMax.value = currentFilters.age_max;
            filterHeightMin.value = currentFilters.height_min;
            filterHeightMax.value = currentFilters.height_max;
            filterWeightMin.value = currentFilters.weight_min;
            filterWeightMax.value = currentFilters.weight_max;
            filterChestMin.value = currentFilters.chest_min;
            filterChestMax.value = currentFilters.chest_max;
        }

        // Применение фильтров
        function applyFilters() {
            currentFilters = {
                city: filterCity.value,
                nationality: filterNationality.value,
                gender: filterGender.value,
                travel_city: filterTravelCity.value,
                age_min: parseInt(filterAgeMin.value) || 18,
                age_max: parseInt(filterAgeMax.value) || 70,
                height_min: parseInt(filterHeightMin.value) || 120,
                height_max: parseInt(filterHeightMax.value) || 220,
                weight_min: parseInt(filterWeightMin.value) || 35,
                weight_max: parseInt(filterWeightMax.value) || 120,
                chest_min: parseInt(filterChestMin.value) || 1,
                chest_max: parseInt(filterChestMax.value) || 12
            };

            updateActiveFilters();
            closeFilters();

            // Скрываем VIP каталоги при применении фильтров
            vipCatalogsSection.style.display = 'none';

            currentPage = 0;
            currentProfiles = [];
            cardsContainer.innerHTML = `<div class="loading">${translations.loading}</div>`;
            loadMoreProfiles();
        }

        // Обновление активных фильтров
        function updateActiveFilters() {
            activeFilters.innerHTML = '';

            const filters = [];

            if (currentFilters.city !== 'all') {
                filters.push(`${currentFilters.city} <span class="remove" onclick="removeFilter('city')">×</span>`);
            }

            if (currentFilters.nationality !== 'all') {
                filters.push(`${currentFilters.nationality} <span class="remove" onclick="removeFilter('nationality')">×</span>`);
            }

            if (currentFilters.gender !== 'all') {
                filters.push(`${currentFilters.gender} <span class="remove" onclick="removeFilter('gender')">×</span>`);
            }

            if (currentFilters.travel_city !== 'all') {
                filters.push(`${currentFilters.travel_city} <span class="remove" onclick="removeFilter('travel_city')">×</span>`);
            }

            if (currentFilters.age_min > 18 || currentFilters.age_max < 70) {
                filters.push(`${currentFilters.age_min}-${currentFilters.age_max} <span class="remove" onclick="removeFilter('age')">×</span>`);
            }

            if (currentFilters.height_min > 120 || currentFilters.height_max < 220) {
                filters.push(`${currentFilters.height_min}-${currentFilters.height_max}cm <span class="remove" onclick="removeFilter('height')">×</span>`);
            }

            if (currentFilters.weight_min > 35 || currentFilters.weight_max < 120) {
                filters.push(`${currentFilters.weight_min}-${currentFilters.weight_max}kg <span class="remove" onclick="removeFilter('weight')">×</span>`);
            }

            if (currentFilters.chest_min > 1 || currentFilters.chest_max < 12) {
                filters.push(`${currentFilters.chest_min}-${currentFilters.chest_max} <span class="remove" onclick="removeFilter('chest')">×</span>`);
            }

            filters.forEach(filter => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = filter;
                activeFilters.appendChild(tag);
            });
        }

        // Удаление фильтра
        function removeFilter(type) {
            switch(type) {
                case 'city':
                    currentFilters.city = 'all';
                    break;
                case 'nationality':
                    currentFilters.nationality = 'all';
                    break;
                case 'gender':
                    currentFilters.gender = 'all';
                    break;
                case 'travel_city':
                    currentFilters.travel_city = 'all';
                    break;
                case 'age':
                    currentFilters.age_min = 18;
                    currentFilters.age_max = 70;
                    break;
                case 'height':
                    currentFilters.height_min = 120;
                    currentFilters.height_max = 220;
                    break;
                case 'weight':
                    currentFilters.weight_min = 35;
                    currentFilters.weight_max = 120;
                    break;
                case 'chest':
                    currentFilters.chest_min = 1;
                    currentFilters.chest_max = 12;
                    break;
            }

            updateFilterInputs();
            updateActiveFilters();

            currentPage = 0;
            currentProfiles = [];
            cardsContainer.innerHTML = `<div class="loading">${translations.loading}</div>`;
            loadMoreProfiles();
        }

        // Инициализация фильтров
        async function initFilters() {
            await loadCities();
            await loadNationalities();
            await loadTravelCities();
            updateFilterInputs();
            updateActiveFilters();
        }

        // Загрузка списка городов
        async function loadCities() {
            try {
                const response = await fetch('/api/filters/cities');
                const data = await response.json();

                filterCity.innerHTML = `<option value="all">${translations.all_cities}</option>`;
                data.cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    filterCity.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Загрузка списка национальностей
        async function loadNationalities() {
            try {
                const response = await fetch('/api/filters/nationalities');
                const data = await response.json();

                filterNationality.innerHTML = `<option value="all">${translations.all_nationalities}</option>`;
                data.nationalities.forEach(nationality => {
                    const option = document.createElement('option');
                    option.value = nationality;
                    option.textContent = nationality;
                    filterNationality.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading nationalities:', error);
            }
        }

        // Загрузка списка городов вылета
        async function loadTravelCities() {
            try {
                const response = await fetch('/api/filters/travel_cities');
                const data = await response.json();

                filterTravelCity.innerHTML = `<option value="all">${translations.all_cities}</option>`;
                data.travel_cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    filterTravelCity.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading travel cities:', error);
            }
        }

        // Загрузка профилей с фильтрами
        async function loadMoreProfiles() {
            if (isLoading) return;

            isLoading = true;
            if (currentPage === 0) {
                loadingMore.style.display = 'block';
            }

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: profilesPerPage,
                    ...currentFilters
                });

                const response = await fetch(`/api/profiles?${params}`);
                const data = await response.json();

                if (data.profiles.length > 0) {
                    currentProfiles = [...currentProfiles, ...data.profiles];
                    renderProfiles(data.profiles);
                    currentPage++;
                } else if (currentPage === 0) {
                    // Если нет анкет на первой странице - показываем закат
                    cardsContainer.innerHTML = `<div class="no-profiles">${translations.no_profiles}</div>`;
                }

                if (!data.has_more) {
                    loadingMore.style.display = 'none';
                }

                updateStats();
            } catch (error) {
                console.error('Error loading profiles:', error);
                cardsContainer.innerHTML = `<div class="loading">${translations.loading}</div>`;
            }

            isLoading = false;
            if (currentPage > 0) {
                loadingMore.style.display = 'none';
            }
        }

        // Отрисовка профилей
        function renderProfiles(profiles) {
            if (currentPage === 0) {
                cardsContainer.innerHTML = '';
            }

            profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'card fade-in';
                // SECURITY FIX: Escape all user-generated content to prevent XSS
                card.innerHTML = `
                    <img src="${escapeHtml(profile.photos[0])}" alt="${escapeHtml(profile.name)}" class="card-image">
                    <div class="card-content">
                        <h3 class="card-title">${escapeHtml(profile.name)} <span class="card-age">${escapeHtml(profile.age)}</span></h3>
                        <p class="card-info">${escapeHtml(profile.city)} • ${escapeHtml(profile.nationality || 'Unknown')} • ${escapeHtml(profile.gender || 'Unknown')}</p>
                        <div class="card-stats">
                            <span class="stat-badge">${escapeHtml(profile.height)} ${escapeHtml(translations.cm)}</span>
                            <span class="stat-badge">${escapeHtml(profile.weight)} ${escapeHtml(translations.kg)}</span>
                            <span class="stat-badge">${escapeHtml(profile.chest)} chest</span>
                        </div>
                        <p class="card-description">${escapeHtml(profile.description)}</p>
                        <div class="card-actions">
                            <button class="btn btn-secondary view-profile" data-id="${profile.id}">
                                <span>${escapeHtml(translations.view_profile)}</span>
                            </button>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });

            // Добавляем обработчики клика на карточки
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', function(event) {
                    if (!event.target.closest('.view-profile')) {
                        const profileId = this.querySelector('.view-profile').getAttribute('data-id');
                        openProfileModal(parseInt(profileId));
                    }
                });
            });

            // Обработчики для кнопок "View Profile"
            document.querySelectorAll('.view-profile').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const profileId = parseInt(this.getAttribute('data-id'));
                    openProfileModal(profileId);
                });
            });
        }

        // Открытие модального окна профиля
        async function openProfileModal(profileId) {
            try {
                const response = await fetch(`/api/profiles/${profileId}`);
                currentProfile = await response.json();

                modalProfileName.textContent = currentProfile.name;
                modalProfileAge.textContent = currentProfile.age;
                modalProfileHeight.textContent = currentProfile.height;
                modalProfileWeight.textContent = currentProfile.weight;
                modalProfileChest.textContent = currentProfile.chest;
                modalProfileGender.textContent = currentProfile.gender || 'Unknown';
                modalProfileCity.textContent = currentProfile.city;
                modalProfileNationality.textContent = currentProfile.nationality || 'Unknown';

                const travelCities = currentProfile.travel_cities ? currentProfile.travel_cities.join(', ') : 'None';
                modalProfileTravelCities.textContent = travelCities;

                modalProfileDescription.textContent = currentProfile.description;

                currentSlideIndex = 0;
                updateSlider();
                loadComments();

                profileModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error loading profile:', error);
                alert(translations.error_loading_profile || 'Error loading profile');
            }
        }

        // Закрытие модального окна профиля
        function closeProfileModal() {
            profileModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Открытие промокода
        function openPromoModal() {
            promoModal.style.display = 'block';
            promoInput.value = '';
            promoResult.style.display = 'none';
        }

        // Закрытие промокода
        function closePromoModal() {
            promoModal.style.display = 'none';
        }

        // Применение промокода
        async function applyPromoCode() {
            const code = promoInput.value.trim();

            if (!code) {
                showPromoResult(translations.enter_promocode, 'error');
                return;
            }

            try {
                const response = await fetch('/api/promocodes/validate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',  // Отправляем cookies для авторизации
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();

                if (result.valid) {
                    showPromoResult(result.message, 'success');
                    // Здесь можно применить скидку к оплате
                } else {
                    showPromoResult(result.message, 'error');
                }
            } catch (error) {
                console.error('Error validating promocode:', error);
                showPromoResult(translations.promocode_invalid, 'error');
            }
        }

        // Показать результат промокода
        function showPromoResult(message, type) {
            promoResult.textContent = message;
            promoResult.className = `promo-result promo-${type}`;
            promoResult.style.display = 'block';
        }

        // Открытие чата
        function openChat() {
            if (!currentProfile) return;

            chatTitle.textContent = `${currentProfile.name}`;
            if (currentProfile.photos && currentProfile.photos.length > 0) {
                chatAvatar.src = currentProfile.photos[0];
            }
            chatBody.innerHTML = '';
            chatInput.value = '';
            fileInput.value = '';

            lastMessageId = 0;
            loadChatHistory();

            chatModal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Помечаем чат как прочитанный
            markChatAsRead(currentProfile.id);
        }

        // Закрытие чата
        function closeChatModal() {
            chatModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            stopChatUpdates();
        }

        // Загрузка истории чата
        async function loadChatHistory() {
            try {
                const response = await fetch(addTelegramUserParam(`/api/chats/${currentProfile.id}/messages`));
                const data = await response.json();

                chatBody.innerHTML = '';

                data.messages.forEach(msg => {
                    renderMessage(msg);
                    if (msg.id > lastMessageId) {
                        lastMessageId = msg.id;
                    }
                });

                chatBody.scrollTop = chatBody.scrollHeight;
                startChatUpdates();

            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Отрисовка сообщения
        function renderMessage(msg) {
            if (msg.is_system) {
                // Системное сообщение - SECURITY FIX: Escape system messages
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-message';
                systemDiv.innerHTML = `<div class="system-bubble">${escapeHtml(msg.text)}</div>`;
                chatBody.appendChild(systemDiv);
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.is_from_user ? 'user' : 'other'}`;

            let messageContent = '';

            if (msg.file_url) {
                // Сообщение с файлом - SECURITY FIX: Escape file data
                let fileContent = '';
                const fileType = msg.file_type || 'file';

                if (fileType === 'image') {
                    fileContent = `
                        <img src="${escapeHtml(msg.file_url)}" alt="Image" class="file-preview">
                    `;
                } else if (fileType === 'video') {
                    fileContent = `
                        <video controls class="file-preview">
                            <source src="${escapeHtml(msg.file_url)}" type="video/mp4">
                            Your browser does not support video.
                        </video>
                    `;
                } else {
                    fileContent = `
                        <div class="file-info">${escapeHtml(msg.file_name)}</div>
                        <a href="${escapeHtml(msg.file_url)}" target="_blank" class="file-link">${escapeHtml(translations.download)}</a>
                    `;
                }

                messageContent = `
                    <div class="message-bubble file-message">
                        ${fileContent}
                        ${msg.text ? `<div style="margin-top: 8px;">${escapeHtml(msg.text)}</div>` : ''}
                        <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                    </div>
                `;
            } else {
                // Текстовое сообщение - SECURITY FIX: Escape message text
                messageContent = `
                    <div class="message-bubble">
                        ${escapeHtml(msg.text)}
                        <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                    </div>
                `;
            }

            messageDiv.innerHTML = messageContent;
            chatBody.appendChild(messageDiv);
        }

        // Проверка новых сообщений
        async function checkForNewMessages() {
            if (!currentProfile) return;

            try {
                const response = await fetch(addTelegramUserParam(`/api/chats/${currentProfile.id}/updates?last_message_id=${lastMessageId}`));
                const data = await response.json();

                if (data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        renderMessage(msg);
                        if (msg.id > lastMessageId) {
                            lastMessageId = msg.id;
                        }

                        // Проверяем, является ли сообщение системным с "transaction successful"
                        if (msg.is_system && msg.text && msg.text.toLowerCase().includes('transaction successful')) {
                            // Очищаем незавершенный платеж
                            if (pendingPayment) {
                                clearPendingPayment();
                            }
                            canComment = true;
                        }
                    });

                    chatBody.scrollTop = chatBody.scrollHeight;
                }

                if (data.last_message_id > lastMessageId) {
                    lastMessageId = data.last_message_id;
                }

            } catch (error) {
                console.error('Error checking updates:', error);
            }
        }

        // Запуск авто-обновления
        function startChatUpdates() {
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
            }

            chatUpdateInterval = setInterval(checkForNewMessages, 2000);
        }

        // Остановка авто-обновления
        function stopChatUpdates() {
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
            lastMessageId = 0;
        }

        // Отправка сообщения
        async function sendMessage(file = null) {
            const messageText = chatInput.value.trim();

            if (!messageText && !file) return;

            try {
                const formData = new FormData();
                if (messageText) formData.append('text', messageText);
                if (file) formData.append('file', file);

                const response = await fetch(addTelegramUserParam(`/api/chats/${currentProfile.id}/messages`), {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                    fileInput.value = '';

                    if (result.message_id > lastMessageId) {
                        lastMessageId = result.message_id;
                    }

                    // Перезагружаем историю чата для отображения нового сообщения
                    loadChatHistory();
                } else {
                    throw new Error('Error sending');
                }

            } catch (error) {
                console.error('Error sending:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message other';
                errorMsg.innerHTML = `<div class="message-bubble">${translations.error_sending}</div>`;
                chatBody.appendChild(errorMsg);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        // Открытие модального окна оплаты
        async function openPaymentModal() {
            if (!currentProfile) return;

            try {
                // Останавливаем таймер, если он запущен
                if (paymentTimerInterval) {
                    clearInterval(paymentTimerInterval);
                    paymentTimerInterval = null;
                }

                // Сбрасываем отображение таймера
                const timerDisplay = document.getElementById('timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = '60:00';
                }

                // Загружаем кошельки
                const response = await fetch('/api/settings/crypto_wallets');
                const wallets = await response.json();

                // Сбрасываем состояние
                cryptoOptions.forEach(opt => opt.classList.remove('selected'));
                walletAddress.style.display = 'none';
                paymentSuccess.style.display = 'none';
                document.getElementById('payment-selection').style.display = 'block';

                // Заполняем информацию о профиле
                paymentProfileName.textContent = `${translations.payment_name || 'Name:'} ${currentProfile.name}`;
                paymentProfileAge.textContent = `${translations.payment_age || 'Age:'} ${currentProfile.age}`;
                paymentProfileGender.textContent = `${translations.payment_gender || 'Gender:'} ${currentProfile.gender || translations.unknown || 'Unknown'}`;
                paymentProfileCity.textContent = `${translations.payment_city || 'City:'} ${currentProfile.city}`;

                paymentModal.style.display = 'block';
            } catch (error) {
                console.error('Error opening payment modal:', error);
                alert(translations.error_payment || 'Error opening payment system');
            }
        }

        // Закрытие модального окна оплаты
        function closePaymentModal() {
            // Останавливаем таймер при закрытии окна
            if (paymentTimerInterval) {
                clearInterval(paymentTimerInterval);
                paymentTimerInterval = null;
            }
            paymentModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Показать адрес кошелька
        async function showWalletAddress(cryptoType) {
            try {
                const response = await fetch('/api/settings/crypto_wallets');
                const wallets = await response.json();

                const address = wallets[cryptoType];
                if (address) {
                    addressText.textContent = address;
                    walletAddress.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading wallet address:', error);
            }
        }

        // Копировать адрес кошелька
        function copyWalletAddress() {
            const address = addressText.textContent;
            navigator.clipboard.writeText(address).then(() => {
                const originalText = copyAddressBtn.textContent;
                copyAddressBtn.textContent = translations.copied;
                setTimeout(() => {
                    copyAddressBtn.textContent = originalText;
                }, 2000);
            });
        }

        // Таймер оплаты (60 минут)
        let paymentTimerInterval = null;
        let pendingPayments = []; // Массив незавершенных платежей
        let currentPendingPayment = null; // Текущий открытый платеж

        function startPaymentTimer(seconds) {
            console.log('[DEBUG] startPaymentTimer called with seconds:', seconds);

            // Очищаем предыдущий таймер, если есть
            if (paymentTimerInterval) {
                console.log('[DEBUG] Clearing previous timer interval');
                clearInterval(paymentTimerInterval);
            }

            let timeRemaining = seconds;
            const timerDisplay = document.getElementById('timer-display');

            if (!timerDisplay) {
                console.error('[ERROR] Timer display element not found in startPaymentTimer!');
                return;
            }

            console.log('[DEBUG] Timer display element found:', timerDisplay);

            // Обновляем дисплей сразу, чтобы показать правильное время
            const updateDisplay = () => {
                const minutes = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                const displayText = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                timerDisplay.textContent = displayText;
                console.log('[DEBUG] Timer updated:', displayText, 'remaining:', timeRemaining);
            };

            // Показываем начальное значение
            updateDisplay();

            // Обновляем таймер каждую секунду
            paymentTimerInterval = setInterval(() => {
                timeRemaining--;
                updateDisplay();

                // Когда время истекло
                if (timeRemaining <= 0) {
                    console.log('[DEBUG] Timer expired, clearing interval');
                    clearInterval(paymentTimerInterval);
                    timerDisplay.textContent = '00:00';
                    // Очищаем незавершенный платеж когда таймер истек
                    clearPendingPayment();
                }
            }, 1000);

            console.log('[DEBUG] Timer interval started, ID:', paymentTimerInterval);
        }

        // Генерация случайного 18-значного кода для ордеров
        function generateOrderCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 18; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }

        // Управление незавершенными платежами
        function savePendingPayment(profile, amount, cryptoType, startTime, paymentId, endTime = null) {
            const payment = {
                id: paymentId || generateOrderCode(), // Уникальный ID платежа
                profile: profile,
                amount: amount,
                cryptoType: cryptoType,
                startTime: startTime,
                endTime: endTime || (startTime + (60 * 60 * 1000)) // Используем переданный endTime или вычисляем (60 минут)
            };

            // Добавляем платеж в массив, если его еще нет
            const existingIndex = pendingPayments.findIndex(p => p.id === payment.id);
            if (existingIndex >= 0) {
                pendingPayments[existingIndex] = payment;
            } else {
                pendingPayments.push(payment);
            }

            localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
            updatePendingPaymentBadges();
        }

        function loadPendingPayments() {
            const saved = localStorage.getItem('pendingPayments');
            if (saved) {
                try {
                    const payments = JSON.parse(saved);
                    const now = Date.now();

                    // Разделяем на активные и истекшие
                    const activePayments = payments.filter(p => p.endTime > now);
                    const expiredPayments = payments.filter(p => p.endTime <= now);

                    // Сохраняем истекшие платежи (только последние 3)
                    if (expiredPayments.length > 0) {
                        const existingExpired = JSON.parse(localStorage.getItem('expiredPayments') || '[]');
                        const allExpired = [...existingExpired, ...expiredPayments];
                        // Сортируем по времени создания и оставляем только 3 последних
                        const sortedExpired = allExpired.sort((a, b) => b.startTime - a.startTime).slice(0, 3);
                        localStorage.setItem('expiredPayments', JSON.stringify(sortedExpired));
                    }

                    // Оставляем только активные платежи
                    pendingPayments = activePayments;

                    // Обновляем localStorage
                    if (pendingPayments.length > 0) {
                        localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
                        updatePendingPaymentBadges();
                    } else {
                        localStorage.removeItem('pendingPayments');
                    }
                } catch (e) {
                    console.error('Error loading pending payments:', e);
                    pendingPayments = [];
                }
            }

            // Миграция старого формата (один платеж)
            const oldSaved = localStorage.getItem('pendingPayment');
            if (oldSaved) {
                try {
                    const oldPayment = JSON.parse(oldSaved);
                    const now = Date.now();
                    if (oldPayment.endTime > now) {
                        oldPayment.id = Date.now();
                        pendingPayments.push(oldPayment);
                        localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
                        updatePendingPaymentBadges();
                    }
                } catch (e) {
                    console.error('Error migrating old payment:', e);
                }
                localStorage.removeItem('pendingPayment');
            }
        }

        function clearPendingPayment(paymentId) {
            if (paymentId) {
                // Удаляем конкретный платеж
                pendingPayments = pendingPayments.filter(p => p.id !== paymentId);
            } else {
                // Удаляем текущий открытый платеж
                if (currentPendingPayment) {
                    pendingPayments = pendingPayments.filter(p => p.id !== currentPendingPayment.id);
                    currentPendingPayment = null;
                }
            }

            if (pendingPayments.length > 0) {
                localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
            } else {
                localStorage.removeItem('pendingPayments');
            }

            updatePendingPaymentBadges();
        }

        function updatePendingPaymentBadges() {
            const count = pendingPayments.length;

            // Обновляем badge в навигации
            const navBadge = document.getElementById('unpaid-badge');
            if (navBadge) {
                if (count > 0) {
                    navBadge.textContent = count > 99 ? '99+' : count;
                    navBadge.style.display = 'block';
                } else {
                    navBadge.style.display = 'none';
                }
            }
        }

        // Синхронизация localStorage с бэкендом - удаляет подтвержденные заказы
        async function syncPendingPaymentsWithBackend() {
            try {
                // Получаем актуальные unpaid заказы с бэкенда
                const response = await fetch(addTelegramUserParam('/api/user/orders?status=unpaid'));
                const data = await response.json();
                const backendUnpaidIds = (data.orders || []).map(o => o.id);

                // Фильтруем localStorage - оставляем только те, что еще unpaid на бэкенде
                const now = Date.now();
                const filteredPayments = pendingPayments.filter(p => {
                    // Удаляем истекшие
                    if (p.endTime <= now) return false;
                    // Оставляем только если заказ еще unpaid на бэкенде
                    return backendUnpaidIds.includes(p.id);
                });

                // Обновляем если есть изменения
                if (filteredPayments.length !== pendingPayments.length) {
                    pendingPayments = filteredPayments;
                    if (pendingPayments.length > 0) {
                        localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
                    } else {
                        localStorage.removeItem('pendingPayments');
                    }
                    updatePendingPaymentBadges();
                }
            } catch (error) {
                console.error('Error syncing pending payments:', error);
            }
        }

        // Запускаем синхронизацию каждые 5 секунд
        setInterval(syncPendingPaymentsWithBackend, 5000);

        function openPendingPayment(paymentId) {
            console.log('[DEBUG] openPendingPayment called with ID:', paymentId);
            console.log('[DEBUG] pendingPayments array:', pendingPayments);

            const payment = paymentId
                ? pendingPayments.find(p => p.id === paymentId)
                : pendingPayments[0]; // Открываем первый платеж если ID не указан

            if (!payment) {
                console.error('[ERROR] Payment not found! ID:', paymentId);
                return;
            }

            console.log('[DEBUG] Found payment:', payment);
            currentPendingPayment = payment;

            // Восстанавливаем профиль и открываем окно оплаты
            currentProfile = payment.profile;

            // Открываем модальное окно
            paymentModal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Показываем страницу успеха с таймером
            document.getElementById('payment-selection').style.display = 'none';
            paymentSuccess.style.display = 'block';

            // Обновляем информацию о платеже
            const cryptoTypeDisplay = {
                'trc20': 'USDT (TRC20)',
                'erc20': 'USDT (ERC20)',
                'bnb': 'BNB (BEP20)',
                'btc': 'Bitcoin'
            };
            document.getElementById('selected-crypto-type').textContent = cryptoTypeDisplay[payment.cryptoType] || payment.cryptoType;
            document.getElementById('selected-amount').textContent = payment.amount;

            // Получаем адрес кошелька из настроек
            fetch('/api/settings/crypto_wallets')
                .then(response => response.json())
                .then(wallets => {
                    const walletAddress = wallets[payment.cryptoType];
                    if (walletAddress) {
                        document.getElementById('address-text').textContent = walletAddress;
                    }
                })
                .catch(error => console.error('Error loading wallet:', error));

            // Очищаем предыдущий таймер перед запуском нового
            if (paymentTimerInterval) {
                clearInterval(paymentTimerInterval);
                paymentTimerInterval = null;
            }

            // Вычисляем оставшееся время
            const now = Date.now();
            const endTime = Number(payment.endTime); // Убеждаемся что это число
            const remainingSeconds = Math.floor((endTime - now) / 1000);

            console.log('[DEBUG] Timer calculation:', {
                now: now,
                endTime: endTime,
                diff: endTime - now,
                remainingSeconds: remainingSeconds
            });

            // Получаем элемент таймера
            const timerDisplay = document.getElementById('timer-display');
            if (!timerDisplay) {
                console.error('[ERROR] Timer display element not found!');
                return;
            }

            // Принудительно сбрасываем таймер
            timerDisplay.textContent = '00:00';

            if (remainingSeconds > 0) {
                console.log('[DEBUG] Starting timer with', remainingSeconds, 'seconds');
                // Используем небольшую задержку чтобы убедиться что DOM обновился
                setTimeout(() => {
                    startPaymentTimer(remainingSeconds);
                }, 10);
            } else {
                console.warn('[WARN] Payment expired, remaining seconds:', remainingSeconds);
                clearPendingPayment(payment.id);
                paymentModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                alert(translations.alert_payment_expired || 'Payment time has expired');
            }
        }

        // Обработка платежа
        async function processPayment() {
            const selectedCrypto = document.querySelector('.crypto-option.selected');
            if (!selectedCrypto) {
                alert(translations.alert_select_crypto || 'Please select cryptocurrency');
                return;
            }

            const amount = paymentAmount.value;
            if (!amount || amount < 10) {
                alert(translations.alert_min_amount || 'Please enter valid amount (min $10)');
                return;
            }

            const cryptoType = selectedCrypto.getAttribute('data-crypto');

            try {
                confirmPaymentBtn.textContent = translations.payment_processing;
                confirmPaymentBtn.disabled = true;

                const response = await fetch('/api/payment/crypto', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile_id: currentProfile.id,
                        amount: amount,
                        currency: 'USD',
                        wallet: cryptoType,
                        telegram_user_id: getTelegramUserId()
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Показываем успех
                    document.getElementById('payment-selection').style.display = 'none';
                    paymentSuccess.style.display = 'block';

                    // Устанавливаем информацию о платеже
                    const cryptoTypeDisplay = {
                        'trc20': 'USDT (TRC20)',
                        'erc20': 'USDT (ERC20)',
                        'bnb': 'BNB (BEP20)',
                        'btc': 'Bitcoin'
                    };
                    document.getElementById('selected-crypto-type').textContent = cryptoTypeDisplay[cryptoType] || cryptoType;
                    document.getElementById('selected-amount').textContent = amount;

                    // Отображаем адрес кошелька
                    if (result.wallet_address) {
                        document.getElementById('address-text').textContent = result.wallet_address;
                    }

                    // Сохраняем незавершенный платеж
                    const startTime = Date.now();
                    const paymentId = result.order_id || Date.now();
                    savePendingPayment(currentProfile, amount, cryptoType, startTime, paymentId);
                    currentPendingPayment = pendingPayments.find(p => p.id === paymentId);

                    // Запускаем таймер на 60 минут (3600 секунд)
                    startPaymentTimer(3600);
                } else {
                    throw new Error(result.message || 'Payment failed');
                }

            } catch (error) {
                console.error('Error processing payment:', error);
                alert((translations.error_payment || 'Payment error') + ': ' + error.message);
            } finally {
                confirmPaymentBtn.textContent = translations.pay_now;
                confirmPaymentBtn.disabled = false;
            }
        }

        // Бесконечная прокрутка
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

            if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoading) {
                loadMoreProfiles();
            }
        }

        // ==================== BOTTOM NAVIGATION & PAGES ====================
        function switchPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Hide main-content if switching away from home
            const mainContent = document.getElementById('main-content');

            if (pageName === 'home') {
                mainContent.style.display = 'block';
                document.getElementById('home-page').classList.add('active');
                document.querySelector('.nav-item[onclick*="home"]').classList.add('active');
            } else {
                mainContent.style.display = 'none';

                if (pageName === 'chats') {
                    document.getElementById('chats-page').classList.add('active');
                    document.querySelector('.nav-item[onclick*="chats"]').classList.add('active');
                    loadUserChats();
                } else if (pageName === 'paid') {
                    document.getElementById('paid-orders-page').classList.add('active');
                    document.querySelector('.nav-item[onclick*="paid"]').classList.add('active');
                    loadOrders('booked');
                } else if (pageName === 'unpaid') {
                    document.getElementById('unpaid-orders-page').classList.add('active');
                    document.querySelector('.nav-item[onclick*="unpaid"]').classList.add('active');
                    loadOrders('unpaid');
                }
            }
        }

        // Load user chats
        async function loadUserChats() {
            const container = document.getElementById('chats-list-container');
            container.innerHTML = `<div class="loading">${translations.loading_chats || 'Loading chats...'}</div>`;

            try {
                const response = await fetch(addTelegramUserParam('/api/user/chats'));
                const data = await response.json();

                container.innerHTML = '';

                if (!data.chats || data.chats.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-text">${translations.no_chats || 'No chats yet'}</div>
                        </div>
                    `;
                    return;
                }

                data.chats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.onclick = () => openChatFromList(chat.profile_id);

                    const lastMessage = chat.last_message || 'No messages yet';
                    const unreadCount = chat.unread_count || 0;
                    const time = chat.last_message_time ? new Date(chat.last_message_time).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}) : '';

                    chatItem.innerHTML = `
                        <img src="${chat.profile_photo || '/default-avatar.png'}" alt="${chat.profile_name}" class="chat-avatar">
                        <div class="chat-info">
                            <div class="chat-name">${chat.profile_name}</div>
                            <div class="chat-last-message">${lastMessage}</div>
                        </div>
                        <div>
                            ${time ? `<div class="chat-time">${time}</div>` : ''}
                            ${unreadCount > 0 ? `<div class="chat-unread">${unreadCount}</div>` : ''}
                        </div>
                    `;
                    container.appendChild(chatItem);
                });

                // Update badge
                const totalUnread = data.chats.reduce((sum, chat) => sum + (chat.unread_count || 0), 0);
                updateChatBadge(totalUnread);

            } catch (error) {
                console.error('Error loading chats:', error);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-text">${translations.error_loading_chats || 'Error loading chats'}</div></div>`;
            }
        }

        async function openChatFromList(profileId) {
            let profile = currentProfiles.find(p => p.id === profileId);

            // Если профиль не найден в текущем списке, загружаем его из API
            if (!profile) {
                try {
                    const response = await fetch(`/api/profiles/${profileId}`);
                    if (response.ok) {
                        profile = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }

            if (profile) {
                currentProfile = profile;
                openChat();
                switchPage('home'); // Return to home to show chat modal
            } else {
                alert(translations.alert_profile_not_found || 'Profile not found');
            }
        }

        function updateChatBadge(count) {
            const badge = document.getElementById('chats-badge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        async function markChatAsRead(profileId) {
            try {
                await fetch(addTelegramUserParam(`/api/chats/${profileId}/mark_read`), {
                    method: 'POST'
                });
                // Обновляем счетчики чатов после пометки как прочитанного
                updateChatBadges();
            } catch (error) {
                console.error('Error marking chat as read:', error);
            }
        }

        // Периодическое обновление счетчиков чатов
        async function updateChatBadges() {
            try {
                const response = await fetch(addTelegramUserParam('/api/user/chats'));
                const data = await response.json();

                if (data.chats) {
                    const totalUnread = data.chats.reduce((sum, chat) => sum + (chat.unread_count || 0), 0);
                    updateChatBadge(totalUnread);
                }
            } catch (error) {
                console.error('Error updating chat badges:', error);
            }
        }

        // Запускаем периодическое обновление счетчиков каждые 10 секунд
        setInterval(updateChatBadges, 10000);

        // Функция для обновления таймеров в списке ордеров
        function updateOrderTimers() {
            const timerElements = document.querySelectorAll('[id^="timer-"]');
            timerElements.forEach(timerEl => {
                const expiresAt = timerEl.getAttribute('data-expires');
                if (!expiresAt) return;

                const now = Date.now();
                const expiresTime = new Date(expiresAt).getTime();
                const remaining = expiresTime - now;

                if (remaining > 0) {
                    const minutes = Math.floor(remaining / 1000 / 60);
                    const seconds = Math.floor((remaining / 1000) % 60);
                    timerEl.textContent = `⏱ ${minutes}:${seconds.toString().padStart(2, '0')} remaining`;
                    timerEl.style.color = '#ffc107';
                } else {
                    timerEl.textContent = '⏱ Expired';
                    timerEl.style.color = '#dc3545';
                }
            });
        }

        // Load orders (booked/unpaid)
        async function loadOrders(type) {
            const listId = type === 'booked' ? 'paid-orders-list' : 'unpaid-orders-list';
            const container = document.getElementById(listId);
            container.innerHTML = `<div class="loading">${translations.loading_orders || 'Loading orders...'}</div>`;

            try {
                const response = await fetch(addTelegramUserParam(`/api/user/orders?status=${type}`));
                const data = await response.json();

                container.innerHTML = '';

                const emptyMessage = type === 'booked'
                    ? (translations.no_booked_orders || 'No booked orders')
                    : (translations.no_unpaid_orders || 'No pending orders');

                if (!data.orders || data.orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-text">${emptyMessage}</div>
                        </div>
                    `;
                    return;
                }

                // Обработка expired ордеров (для всех типов)
                const now = Date.now();
                const expiredOrders = [];
                const activeOrders = [];

                data.orders.forEach(order => {
                    if (order.expires_at && new Date(order.expires_at).getTime() < now) {
                        order.isExpired = true;
                        expiredOrders.push(order);
                    } else {
                        activeOrders.push(order);
                    }
                });

                // Оставляем только 3 последних expired ордера
                if (expiredOrders.length > 3) {
                    // Сортируем по дате создания (новые первыми)
                    expiredOrders.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

                    // Берем первые 3
                    const ordersToKeep = expiredOrders.slice(0, 3);
                    const ordersToDelete = expiredOrders.slice(3);

                    // Удаляем старые expired ордера через API
                    ordersToDelete.forEach(order => {
                        fetch(`/api/orders/${order.id}`, {
                            method: 'DELETE'
                        }).catch(err => console.error('Error deleting expired order:', err));
                    });

                    // Обновляем список orders
                    data.orders = [...activeOrders, ...ordersToKeep];
                }

                data.orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';

                    // Для pending заказов добавляем курсор pointer и обработчик клика
                    if (type === 'unpaid') {
                        orderItem.style.cursor = 'pointer';

                        // Находим соответствующий pending платеж в localStorage
                        const pendingPayment = pendingPayments.find(p => p.id === order.id || p.profile.id === order.profile_id);

                        orderItem.onclick = () => {
                            if (pendingPayment) {
                                openPendingPayment(pendingPayment.id);
                            } else {
                                // Если платежа нет в localStorage, но есть в backend, восстанавливаем его
                                // Вычисляем оставшееся время
                                if (order.expires_at) {
                                    const expiresTime = new Date(order.expires_at).getTime();
                                    const now = Date.now();
                                    if (expiresTime > now) {
                                        // Загружаем профиль и восстанавливаем платеж
                                        fetch(`/api/profiles/${order.profile_id}`)
                                            .then(res => res.json())
                                            .then(profileData => {
                                                const createdTime = new Date(order.created_at).getTime();
                                                // Сохраняем платеж в localStorage
                                                savePendingPayment(
                                                    profileData,
                                                    order.amount,
                                                    order.crypto_type,
                                                    createdTime,
                                                    order.id,
                                                    expiresTime // Передаем правильное время истечения из backend
                                                );
                                                // Открываем окно с задержкой, чтобы убедиться что платеж сохранен
                                                setTimeout(() => {
                                                    openPendingPayment(order.id);
                                                }, 50);
                                            })
                                            .catch(err => console.error('Error loading profile:', err));
                                    } else {
                                        alert(translations.alert_payment_expired || 'Payment time has expired');
                                    }
                                }
                            }
                        };
                    }

                    const cryptoTypeDisplay = {
                        'trc20': 'USDT (TRC20)',
                        'erc20': 'USDT (ERC20)',
                        'bnb': 'BNB (BEP20)',
                        'btc': 'Bitcoin'
                    };

                    // Создаем уникальный ID для таймера
                    const timerId = `timer-${order.id}`;

                    // Добавляем рамку для booked ордеров
                    if (type === 'booked') {
                        if (order.isExpired) {
                            // Красная рамка для expired ордеров
                            orderItem.style.border = '2px solid #dc3545';
                            orderItem.style.background = 'linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.1))';
                        } else {
                            // Зеленую рамку для подтвержденных booking
                            orderItem.style.border = '2px solid #28a745';
                            orderItem.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.1))';
                        }
                    }

                    // Определяем статус и баннер
                    let statusText = translations.order_pending || 'Pending';
                    let statusClass = type;
                    let bannerHtml = '';

                    if (type === 'booked') {
                        if (order.isExpired) {
                            statusText = translations.order_expired || 'Expired';
                            statusClass = 'expired';
                            bannerHtml = `<div style="background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; border-radius: 8px; padding: 8px; margin: 10px 0; text-align: center; color: #dc3545; font-weight: 600;">✗ ${translations.booking_expired || 'Booking Expired'}</div>`;
                        } else {
                            statusText = translations.order_confirmed || 'Confirmed';
                            bannerHtml = `<div style="background: rgba(40, 167, 69, 0.2); border: 1px solid #28a745; border-radius: 8px; padding: 8px; margin: 10px 0; text-align: center; color: #28a745; font-weight: 600;">✓ ${translations.booking_confirmed || 'Booking Confirmed'}</div>`;
                        }
                    }

                    orderItem.innerHTML = `
                        <div class="order-header">
                            <span style="font-weight: 700; color: var(--text); font-size: 10px; word-break: break-all;">${translations.order_number || 'Order'} #${order.order_number || order.id}</span>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        ${bannerHtml}
                        <div class="order-profile">
                            <img src="${order.profile_photo || '/default-avatar.png'}" alt="${order.profile_name}" class="order-avatar">
                            <div>
                                <div style="font-weight: 600; color: var(--text);">${order.profile_name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${cryptoTypeDisplay[order.crypto_type] || order.crypto_type || 'Crypto'}</div>
                            </div>
                        </div>
                        <div class="order-info">
                            <div>Amount: <strong>$${order.amount}</strong></div>
                            <div>Date: ${new Date(order.created_at).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</div>
                            ${type === 'unpaid' && order.expires_at ? `<div id="${timerId}" data-expires="${order.expires_at}" style="color: #ffc107; font-weight: 600;"></div>` : ''}
                        </div>
                    `;
                    container.appendChild(orderItem);
                });

                // Запускаем обновление таймеров для pending orders
                if (type === 'unpaid') {
                    updateOrderTimers();
                    // Обновляем каждую секунду
                    if (window.orderTimersInterval) {
                        clearInterval(window.orderTimersInterval);
                    }
                    window.orderTimersInterval = setInterval(updateOrderTimers, 1000);
                }

                // Update unpaid badge
                if (type === 'unpaid') {
                    const badge = document.getElementById('unpaid-badge');
                    if (data.orders.length > 0) {
                        badge.textContent = data.orders.length > 99 ? '99+' : data.orders.length;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // Update booked badge
                if (type === 'booked') {
                    const badge = document.getElementById('booked-badge');
                    if (data.orders.length > 0) {
                        badge.textContent = data.orders.length > 99 ? '99+' : data.orders.length;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-text">${translations.error_loading_orders || 'Error loading orders'}</div></div>`;
            }
        }

        // Stop chat updates when closing chat
        closeChatBtn.addEventListener('click', () => {
            chatModal.style.display = 'none';
            stopChatUpdates();
        });

        // Telegram WebApp интеграция
        if (typeof window.Telegram === 'undefined') {
            window.Telegram = {
                WebApp: {
                    initData: 'test',
                    initDataUnsafe: {
                        user: {
                            id: 123456,
                            first_name: 'Test',
                            last_name: 'User',
                            username: 'testuser'
                        }
                    },
                    ready: function() { console.log('Telegram WebApp ready') },
                    expand: function() { console.log('WebApp expanded') },
                    close: function() { console.log('WebApp closed') },
                    sendData: function(data) {
                        console.log('Data sent to bot:', data)
                    }
                }
            };
        }

        // Telegram бот - конфигурация
        const TELEGRAM_BOT_USERNAME = 'YOUR_BOT_USERNAME'; // Замените на имя вашего бота

        // Открытие Telegram бота
        function openTelegramBot() {
            const botUrl = `https://t.me/${TELEGRAM_BOT_USERNAME}`;

            if (window.Telegram && window.Telegram.WebApp) {
                // Если в Telegram Mini App, открываем внутри Telegram
                window.Telegram.WebApp.openTelegramLink(botUrl);
            } else {
                // В обычном браузере
                window.open(botUrl, '_blank');
            }
        }
    </script>

    <!-- Плавающая кнопка Telegram бота -->
    <button class="telegram-bot-btn" onclick="openTelegramBot()" data-tooltip="Contact Support Bot">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-12S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.96 1.24-5.53 3.65-.52.36-.99.53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.37-.48 1.02-.73 3.99-1.73 6.65-2.87 7.98-3.43 3.8-1.58 4.59-1.86 5.1-1.87.11 0 .37.03.53.17.14.12.18.28.19.39.01.11.03.36.02.55z"/>
        </svg>
    </button>

</body>
</html>
